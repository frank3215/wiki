<!doctype html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="generator" content="TiddlyWiki" />
<meta name="tiddlywiki-version" content="5.2.0" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<meta name="mobile-web-app-capable" content="yes"/>
<meta name="format-detection" content="telephone=no">
<link id="faviconLink" rel="shortcut icon" href="favicon.ico">
<link rel="stylesheet" href="static.css">
<title>$:/boot/boot.js: OI Index

— by frank3215
</title>
</head>
<body class="tc-body">

<section class="tc-story-river tc-static-story-river">
<p><div class="tc-tiddler-frame tc-tiddler-view-frame tc-tiddler-exists tc-tiddler-system " data-tags="" data-tiddler-title="$:/boot/boot.js"><div class="tc-tiddler-title"><div class="tc-titlebar"><span class="tc-tiddler-controls"><button aria-expanded="false" aria-label="更多" class="tc-btn-invisible tc-btn-%24%3A%2Fcore%2Fui%2FButtons%2Fmore-tiddler-actions" title="更多动作"></button><div class=" tc-reveal" hidden="true"></div><button aria-label="编辑" class="tc-btn-invisible tc-btn-%24%3A%2Fcore%2Fui%2FButtons%2Fedit" title="编辑此条目"></button><button aria-label="关闭" class="tc-btn-invisible tc-btn-%24%3A%2Fcore%2Fui%2FButtons%2Fclose" title="关闭此条目"></button></span><span><h2 class="tc-title" title="此为系统条目"><span class="tc-system-title-prefix">$:/</span>boot/boot.js</h2></span></div><div class="tc-tiddler-info tc-popup-handle tc-reveal" hidden="true"></div></div><div class=" tc-reveal" hidden="true"></div>
<div class=" tc-reveal"><div class="tc-subtitle"><a class="tc-tiddlylink tc-tiddlylink-missing" href=".html"></a></div></div><div class=" tc-reveal">
<div class="tc-tags-wrapper"></div>
</div>

<div class="tc-tiddler-body tc-reveal"><pre class="javascript hljs"><code><span class="hljs-comment">/*\
title: $:/boot/boot.js
type: application/javascript

The main boot kernel for TiddlyWiki. This single file creates a barebones TW environment that is just sufficient to bootstrap the modules containing the main logic of the application.

On the server this file is executed directly to boot TiddlyWiki. In the browser, this file is packed into a single HTML file.

\*/</span>

<span class="hljs-keyword">var</span> _boot = (<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">$tw</span>) </span>{

<span class="hljs-comment">/*jslint node: true, browser: true */</span>
<span class="hljs-comment">/*global modules: false, $tw: false */</span>
<span class="hljs-meta">"use strict"</span>;

<span class="hljs-comment">// Include bootprefix if we're not given module data</span>
<span class="hljs-keyword">if</span>(!$tw) {
    $tw = <span class="hljs-built_in">require</span>(<span class="hljs-string">"./bootprefix.js"</span>).bootprefix();
}

$tw.utils = $tw.utils || <span class="hljs-built_in">Object</span>.create(<span class="hljs-literal">null</span>);

<span class="hljs-comment">/////////////////////////// Standard node.js libraries</span>

<span class="hljs-keyword">var</span> fs, path, vm;
<span class="hljs-keyword">if</span>($tw.node) {
    fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">"fs"</span>);
    path = <span class="hljs-built_in">require</span>(<span class="hljs-string">"path"</span>);
    vm = <span class="hljs-built_in">require</span>(<span class="hljs-string">"vm"</span>);
}

<span class="hljs-comment">/////////////////////////// Utility functions</span>

$tw.boot.log = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">str</span>) </span>{
    $tw.boot.logMessages = $tw.boot.logMessages || [];
    $tw.boot.logMessages.push(str);
}

<span class="hljs-comment">/*
Check if an object has a property
*/</span>
$tw.utils.hop = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">object,property</span>) </span>{
    <span class="hljs-keyword">return</span> object ? <span class="hljs-built_in">Object</span>.prototype.hasOwnProperty.call(object,property) : <span class="hljs-literal">false</span>;
};

<span class="hljs-comment">/*
Determine if a value is an array
*/</span>
$tw.utils.isArray = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">value</span>) </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">Object</span>.prototype.toString.call(value) == <span class="hljs-string">"[object Array]"</span>;
};

<span class="hljs-comment">/*
Check if an array is equal by value and by reference.
*/</span>
$tw.utils.isArrayEqual = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">array1,array2</span>) </span>{
    <span class="hljs-keyword">if</span>(array1 === array2) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
    array1 = array1 || [];
    array2 = array2 || [];
    <span class="hljs-keyword">if</span>(array1.length !== array2.length) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
    <span class="hljs-keyword">return</span> array1.every(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">value,index</span>) </span>{
        <span class="hljs-keyword">return</span> value === array2[index];
    });
};

<span class="hljs-comment">/*
Push entries onto an array, removing them first if they already exist in the array
    array: array to modify (assumed to be free of duplicates)
    value: a single value to push or an array of values to push
*/</span>
$tw.utils.pushTop = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">array,value</span>) </span>{
    <span class="hljs-keyword">var</span> t,p;
    <span class="hljs-keyword">if</span>($tw.utils.isArray(value)) {
        <span class="hljs-comment">// Remove any array entries that are duplicated in the new values</span>
        <span class="hljs-keyword">if</span>(value.length !== <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">if</span>(array.length !== <span class="hljs-number">0</span>) {
                <span class="hljs-keyword">if</span>(value.length &lt; array.length) {
                    <span class="hljs-keyword">for</span>(t=<span class="hljs-number">0</span>; t&lt;value.length; t++) {
                        p = array.indexOf(value[t]);
                        <span class="hljs-keyword">if</span>(p !== <span class="hljs-number">-1</span>) {
                            array.splice(p,<span class="hljs-number">1</span>);
                        }
                    }
                } <span class="hljs-keyword">else</span> {
                    <span class="hljs-keyword">for</span>(t=array.length<span class="hljs-number">-1</span>; t&gt;=<span class="hljs-number">0</span>; t--) {
                        p = value.indexOf(array[t]);
                        <span class="hljs-keyword">if</span>(p !== <span class="hljs-number">-1</span>) {
                            array.splice(t,<span class="hljs-number">1</span>);
                        }
                    }
                }
            }
            <span class="hljs-comment">// Push the values on top of the main array</span>
            array.push.apply(array,value);
        }
    } <span class="hljs-keyword">else</span> {
        p = array.indexOf(value);
        <span class="hljs-keyword">if</span>(p !== <span class="hljs-number">-1</span>) {
            array.splice(p,<span class="hljs-number">1</span>);
        }
        array.push(value);
    }
    <span class="hljs-keyword">return</span> array;
};

<span class="hljs-comment">/*
Determine if a value is a date
*/</span>
$tw.utils.isDate = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">value</span>) </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">Object</span>.prototype.toString.call(value) === <span class="hljs-string">"[object Date]"</span>;
};

<span class="hljs-comment">/*
Iterate through all the own properties of an object or array. Callback is invoked with (element,title,object)
*/</span>
$tw.utils.each = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">object,callback</span>) </span>{
    <span class="hljs-keyword">var</span> next,f,length;
    <span class="hljs-keyword">if</span>(object) {
        <span class="hljs-keyword">if</span>(<span class="hljs-built_in">Object</span>.prototype.toString.call(object) == <span class="hljs-string">"[object Array]"</span>) {
            <span class="hljs-keyword">for</span> (f=<span class="hljs-number">0</span>, length=object.length; f&lt;length; f++) {
                next = callback(object[f],f,object);
                <span class="hljs-keyword">if</span>(next === <span class="hljs-literal">false</span>) {
                    <span class="hljs-keyword">break</span>;
                }
            }
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">var</span> keys = <span class="hljs-built_in">Object</span>.keys(object);
            <span class="hljs-keyword">for</span> (f=<span class="hljs-number">0</span>, length=keys.length; f&lt;length; f++) {
                <span class="hljs-keyword">var</span> key = keys[f];
                next = callback(object[key],key,object);
                <span class="hljs-keyword">if</span>(next === <span class="hljs-literal">false</span>) {
                    <span class="hljs-keyword">break</span>;
                }
            }
        }
    }
};

<span class="hljs-comment">/*
Helper for making DOM elements
tag: tag name
options: see below
Options include:
namespace: defaults to http://www.w3.org/1999/xhtml
attributes: hashmap of attribute values
style: hashmap of styles
text: text to add as a child node
children: array of further child nodes
innerHTML: optional HTML for element
class: class name(s)
document: defaults to current document
eventListeners: array of event listeners (this option won't work until $tw.utils.addEventListeners() has been loaded)
*/</span>
$tw.utils.domMaker = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">tag,options</span>) </span>{
    <span class="hljs-keyword">var</span> doc = options.document || <span class="hljs-built_in">document</span>;
    <span class="hljs-keyword">var</span> element = doc.createElementNS(options.namespace || <span class="hljs-string">"http://www.w3.org/1999/xhtml"</span>,tag);
    <span class="hljs-keyword">if</span>(options[<span class="hljs-string">"class"</span>]) {
        element.className = options[<span class="hljs-string">"class"</span>];
    }
    <span class="hljs-keyword">if</span>(options.text) {
        element.appendChild(doc.createTextNode(options.text));
    }
    $tw.utils.each(options.children,<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">child</span>) </span>{
        element.appendChild(child);
    });
    <span class="hljs-keyword">if</span>(options.innerHTML) {
        element.innerHTML = options.innerHTML;
    }
    $tw.utils.each(options.attributes,<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">attribute,name</span>) </span>{
        element.setAttribute(name,attribute);
    });
    $tw.utils.each(options.style,<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">value,name</span>) </span>{
        element.style[name] = value;
    });
    <span class="hljs-keyword">if</span>(options.eventListeners) {
        $tw.utils.addEventListeners(element,options.eventListeners);
    }
    <span class="hljs-keyword">return</span> element;
};

<span class="hljs-comment">/*
Display an error and exit
*/</span>
$tw.utils.error = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err</span>) </span>{
    <span class="hljs-comment">// Prepare the error message</span>
    <span class="hljs-keyword">var</span> errHeading = ( $tw.language == <span class="hljs-literal">undefined</span> ? <span class="hljs-string">"Internal JavaScript Error"</span> : $tw.language.getString(<span class="hljs-string">"InternalJavaScriptError/Title"</span>) ),
        promptMsg = ( $tw.language == <span class="hljs-literal">undefined</span> ? <span class="hljs-string">"Well, this is embarrassing. It is recommended that you restart TiddlyWiki by refreshing your browser"</span> : $tw.language.getString(<span class="hljs-string">"InternalJavaScriptError/Hint"</span>) );
    <span class="hljs-comment">// Log the error to the console</span>
    <span class="hljs-built_in">console</span>.error($tw.node ? <span class="hljs-string">"\x1b[1;31m"</span> + err + <span class="hljs-string">"\x1b[0m"</span> : err);
    <span class="hljs-keyword">if</span>($tw.browser &amp;&amp; !$tw.node) {
        <span class="hljs-comment">// Display an error message to the user</span>
        <span class="hljs-keyword">var</span> dm = $tw.utils.domMaker,
            heading = dm(<span class="hljs-string">"h1"</span>,{<span class="hljs-attr">text</span>: errHeading}),
            prompt = dm(<span class="hljs-string">"div"</span>,{<span class="hljs-attr">text</span>: promptMsg, <span class="hljs-string">"class"</span>: <span class="hljs-string">"tc-error-prompt"</span>}),
            message = dm(<span class="hljs-string">"div"</span>,{<span class="hljs-attr">text</span>: err, <span class="hljs-string">"class"</span>:<span class="hljs-string">"tc-error-message"</span>}),
            button = dm(<span class="hljs-string">"div"</span>,{<span class="hljs-attr">children</span>: [dm(<span class="hljs-string">"button"</span>,{<span class="hljs-attr">text</span>: ( $tw.language == <span class="hljs-literal">undefined</span> ? <span class="hljs-string">"close"</span> : $tw.language.getString(<span class="hljs-string">"Buttons/Close/Caption"</span>) )})], <span class="hljs-string">"class"</span>: <span class="hljs-string">"tc-error-prompt"</span>}),
            form = dm(<span class="hljs-string">"form"</span>,{<span class="hljs-attr">children</span>: [heading,prompt,message,button], <span class="hljs-string">"class"</span>: <span class="hljs-string">"tc-error-form"</span>});
        <span class="hljs-built_in">document</span>.body.insertBefore(form,<span class="hljs-built_in">document</span>.body.firstChild);
        form.addEventListener(<span class="hljs-string">"submit"</span>,<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">event</span>) </span>{
            <span class="hljs-built_in">document</span>.body.removeChild(form);
            event.preventDefault();
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        },<span class="hljs-literal">true</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(!$tw.browser) {
        <span class="hljs-comment">// Exit if we're under node.js</span>
        process.exit(<span class="hljs-number">1</span>);
    }
};

<span class="hljs-comment">/*
Use our custom error handler if we're in the browser
*/</span>
<span class="hljs-keyword">if</span>($tw.boot.tasks.trapErrors) {
    <span class="hljs-built_in">window</span>.onerror = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">errorMsg,url,lineNumber</span>) </span>{
        $tw.utils.error(errorMsg);
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    };
}

<span class="hljs-comment">/*
Extend an object with the properties from a list of source objects
*/</span>
$tw.utils.extend = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">object <span class="hljs-regexp">/*, sourceObjectList */</span></span>) </span>{
    $tw.utils.each(<span class="hljs-built_in">Array</span>.prototype.slice.call(<span class="hljs-built_in">arguments</span>,<span class="hljs-number">1</span>),<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">source</span>) </span>{
        <span class="hljs-keyword">if</span>(source) {
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> p <span class="hljs-keyword">in</span> source) {
                object[p] = source[p];
            }
        }
    });
    <span class="hljs-keyword">return</span> object;
};

<span class="hljs-comment">/*
Fill in any null or undefined properties of an object with the properties from a list of source objects. Each property that is an object is called recursively
*/</span>
$tw.utils.deepDefaults = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">object <span class="hljs-regexp">/*, sourceObjectList */</span></span>) </span>{
    $tw.utils.each(<span class="hljs-built_in">Array</span>.prototype.slice.call(<span class="hljs-built_in">arguments</span>,<span class="hljs-number">1</span>),<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">source</span>) </span>{
        <span class="hljs-keyword">if</span>(source) {
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> p <span class="hljs-keyword">in</span> source) {
                <span class="hljs-keyword">if</span>(object[p] === <span class="hljs-literal">null</span> || object[p] === <span class="hljs-literal">undefined</span>) {
                    object[p] = source[p];
                }
                <span class="hljs-keyword">if</span>(<span class="hljs-keyword">typeof</span> object[p] === <span class="hljs-string">"object"</span> &amp;&amp; <span class="hljs-keyword">typeof</span> source[p] === <span class="hljs-string">"object"</span>) {
                    $tw.utils.deepDefaults(object[p],source[p]);
                }
            }
        }
    });
    <span class="hljs-keyword">return</span> object;
};

<span class="hljs-comment">/*
Convert "&amp;amp;" to &amp;, "&amp;nbsp;" to nbsp, "&amp;lt;" to &lt;, "&amp;gt;" to &gt; and "&amp;quot;" to "
*/</span>
$tw.utils.htmlDecode = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">s</span>) </span>{
    <span class="hljs-keyword">return</span> s.toString().replace(<span class="hljs-regexp">/&amp;lt;/mg</span>,<span class="hljs-string">"&lt;"</span>).replace(<span class="hljs-regexp">/&amp;nbsp;/mg</span>,<span class="hljs-string">"\xA0"</span>).replace(<span class="hljs-regexp">/&amp;gt;/mg</span>,<span class="hljs-string">"&gt;"</span>).replace(<span class="hljs-regexp">/&amp;quot;/mg</span>,<span class="hljs-string">"\""</span>).replace(<span class="hljs-regexp">/&amp;amp;/mg</span>,<span class="hljs-string">"&amp;"</span>);
};

<span class="hljs-comment">/*
Get the browser location.hash. We don't use location.hash because of the way that Firefox auto-urldecodes it (see http://stackoverflow.com/questions/1703552/encoding-of-window-location-hash)
*/</span>
$tw.utils.getLocationHash = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> href = <span class="hljs-built_in">window</span>.location.href;
    <span class="hljs-keyword">var</span> idx = href.indexOf(<span class="hljs-string">'#'</span>);
    <span class="hljs-keyword">if</span>(idx === <span class="hljs-number">-1</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"#"</span>;
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(idx &lt; href.length<span class="hljs-number">-1</span> &amp;&amp; href[idx+<span class="hljs-number">1</span>] === <span class="hljs-string">'#'</span>) {
        <span class="hljs-comment">// Special case: ignore location hash if it itself starts with a #</span>
        <span class="hljs-keyword">return</span> <span class="hljs-string">"#"</span>;
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">return</span> href.substring(idx);
    }
};

<span class="hljs-comment">/*
Pad a string to a given length with "0"s. Length defaults to 2
*/</span>
$tw.utils.pad = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">value,length</span>) </span>{
    length = length || <span class="hljs-number">2</span>;
    <span class="hljs-keyword">var</span> s = value.toString();
    <span class="hljs-keyword">if</span>(s.length &lt; length) {
        s = <span class="hljs-string">"000000000000000000000000000"</span>.substr(<span class="hljs-number">0</span>,length - s.length) + s;
    }
    <span class="hljs-keyword">return</span> s;
};

<span class="hljs-comment">// Convert a date into UTC YYYYMMDDHHMMSSmmm format</span>
$tw.utils.stringifyDate = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">value</span>) </span>{
    <span class="hljs-keyword">return</span> value.getUTCFullYear() +
            $tw.utils.pad(value.getUTCMonth() + <span class="hljs-number">1</span>) +
            $tw.utils.pad(value.getUTCDate()) +
            $tw.utils.pad(value.getUTCHours()) +
            $tw.utils.pad(value.getUTCMinutes()) +
            $tw.utils.pad(value.getUTCSeconds()) +
            $tw.utils.pad(value.getUTCMilliseconds(),<span class="hljs-number">3</span>);
};

<span class="hljs-comment">// Parse a date from a UTC YYYYMMDDHHMMSSmmm format string</span>
$tw.utils.parseDate = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">value</span>) </span>{
    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">typeof</span> value === <span class="hljs-string">"string"</span>) {
        <span class="hljs-keyword">var</span> negative = <span class="hljs-number">1</span>;
        <span class="hljs-keyword">if</span>(value.charAt(<span class="hljs-number">0</span>) === <span class="hljs-string">"-"</span>) {
            negative = <span class="hljs-number">-1</span>;
            value = value.substr(<span class="hljs-number">1</span>);
        }
        <span class="hljs-keyword">var</span> year = <span class="hljs-built_in">parseInt</span>(value.substr(<span class="hljs-number">0</span>,<span class="hljs-number">4</span>),<span class="hljs-number">10</span>) * negative,
            d = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(<span class="hljs-built_in">Date</span>.UTC(year,
                <span class="hljs-built_in">parseInt</span>(value.substr(<span class="hljs-number">4</span>,<span class="hljs-number">2</span>),<span class="hljs-number">10</span>)<span class="hljs-number">-1</span>,
                <span class="hljs-built_in">parseInt</span>(value.substr(<span class="hljs-number">6</span>,<span class="hljs-number">2</span>),<span class="hljs-number">10</span>),
                <span class="hljs-built_in">parseInt</span>(value.substr(<span class="hljs-number">8</span>,<span class="hljs-number">2</span>)||<span class="hljs-string">"00"</span>,<span class="hljs-number">10</span>),
                <span class="hljs-built_in">parseInt</span>(value.substr(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>)||<span class="hljs-string">"00"</span>,<span class="hljs-number">10</span>),
                <span class="hljs-built_in">parseInt</span>(value.substr(<span class="hljs-number">12</span>,<span class="hljs-number">2</span>)||<span class="hljs-string">"00"</span>,<span class="hljs-number">10</span>),
                <span class="hljs-built_in">parseInt</span>(value.substr(<span class="hljs-number">14</span>,<span class="hljs-number">3</span>)||<span class="hljs-string">"000"</span>,<span class="hljs-number">10</span>)));
          d.setUTCFullYear(year); <span class="hljs-comment">// See https://stackoverflow.com/a/5870822</span>
          <span class="hljs-keyword">return</span> d;
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>($tw.utils.isDate(value)) {
        <span class="hljs-keyword">return</span> value;
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    }
};

<span class="hljs-comment">// Stringify an array of tiddler titles into a list string</span>
$tw.utils.stringifyList = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">value</span>) </span>{
    <span class="hljs-keyword">if</span>($tw.utils.isArray(value)) {
        <span class="hljs-keyword">var</span> result = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Array</span>(value.length);
        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> t=<span class="hljs-number">0</span>, l=value.length; t&lt;l; t++) {
            <span class="hljs-keyword">var</span> entry = value[t] || <span class="hljs-string">""</span>;
            <span class="hljs-keyword">if</span>(entry.indexOf(<span class="hljs-string">" "</span>) !== <span class="hljs-number">-1</span>) {
                result[t] = <span class="hljs-string">"[["</span> + entry + <span class="hljs-string">"]]"</span>;
            } <span class="hljs-keyword">else</span> {
                result[t] = entry;
            }
        }
        <span class="hljs-keyword">return</span> result.join(<span class="hljs-string">" "</span>);
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">return</span> value || <span class="hljs-string">""</span>;
    }
};

<span class="hljs-comment">// Parse a string array from a bracketted list. For example "OneTiddler [[Another Tiddler]] LastOne"</span>
$tw.utils.parseStringArray = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">value, allowDuplicate</span>) </span>{
    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">typeof</span> value === <span class="hljs-string">"string"</span>) {
        <span class="hljs-keyword">var</span> memberRegExp = <span class="hljs-regexp">/(?:^|[^\S\xA0])(?:\[\[(.*?)\]\])(?=[^\S\xA0]|$)|([\S\xA0]+)/mg</span>,
            results = [], names = {},
            match;
        <span class="hljs-keyword">do</span> {
            match = memberRegExp.exec(value);
            <span class="hljs-keyword">if</span>(match) {
                <span class="hljs-keyword">var</span> item = match[<span class="hljs-number">1</span>] || match[<span class="hljs-number">2</span>];
                <span class="hljs-keyword">if</span>(item !== <span class="hljs-literal">undefined</span> &amp;&amp; (!$tw.utils.hop(names,item) || allowDuplicate)) {
                    results.push(item);
                    names[item] = <span class="hljs-literal">true</span>;
                }
            }
        } <span class="hljs-keyword">while</span>(match);
        <span class="hljs-keyword">return</span> results;
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>($tw.utils.isArray(value)) {
        <span class="hljs-keyword">return</span> value;
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    }
};

<span class="hljs-comment">// Parse a block of name:value fields. The `fields` object is used as the basis for the return value</span>
$tw.utils.parseFields = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">text,fields</span>) </span>{
    fields = fields || <span class="hljs-built_in">Object</span>.create(<span class="hljs-literal">null</span>);
    text.split(<span class="hljs-regexp">/\r?\n/mg</span>).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">line</span>) </span>{
        <span class="hljs-keyword">if</span>(line.charAt(<span class="hljs-number">0</span>) !== <span class="hljs-string">"#"</span>) {
            <span class="hljs-keyword">var</span> p = line.indexOf(<span class="hljs-string">":"</span>);
            <span class="hljs-keyword">if</span>(p !== <span class="hljs-number">-1</span>) {
                <span class="hljs-keyword">var</span> field = line.substr(<span class="hljs-number">0</span>, p).trim(),
                    value = line.substr(p+<span class="hljs-number">1</span>).trim();
                <span class="hljs-keyword">if</span>(field) {
                    fields[field] = value;
                }
            }
        }
    });
    <span class="hljs-keyword">return</span> fields;
};

<span class="hljs-comment">/*
Resolves a source filepath delimited with `/` relative to a specified absolute root filepath.
In relative paths, the special folder name `..` refers to immediate parent directory, and the
name `.` refers to the current directory
*/</span>
$tw.utils.resolvePath = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">sourcepath,rootpath</span>) </span>{
    <span class="hljs-comment">// If the source path starts with ./ or ../ then it is relative to the root</span>
    <span class="hljs-keyword">if</span>(sourcepath.substr(<span class="hljs-number">0</span>,<span class="hljs-number">2</span>) === <span class="hljs-string">"./"</span> || sourcepath.substr(<span class="hljs-number">0</span>,<span class="hljs-number">3</span>) === <span class="hljs-string">"../"</span> ) {
        <span class="hljs-keyword">var</span> src = sourcepath.split(<span class="hljs-string">"/"</span>),
            root = rootpath.split(<span class="hljs-string">"/"</span>);
        <span class="hljs-comment">// Remove the filename part of the root</span>
        root.splice(root.length<span class="hljs-number">-1</span>,<span class="hljs-number">1</span>);
        <span class="hljs-comment">// Process the source path bit by bit onto the end of the root path</span>
        <span class="hljs-keyword">while</span>(src.length &gt; <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">var</span> c = src.shift();
            <span class="hljs-keyword">if</span>(c === <span class="hljs-string">".."</span>) { <span class="hljs-comment">// Slice off the last root entry for a double dot</span>
                <span class="hljs-keyword">if</span>(root.length &gt; <span class="hljs-number">0</span>) {
                    root.splice(root.length<span class="hljs-number">-1</span>,<span class="hljs-number">1</span>);
                }
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(c !== <span class="hljs-string">"."</span>) { <span class="hljs-comment">// Ignore dots</span>
                root.push(c); <span class="hljs-comment">// Copy other elements across</span>
            }
        }
        <span class="hljs-keyword">return</span> root.join(<span class="hljs-string">"/"</span>);
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// If it isn't relative, just return the path</span>
        <span class="hljs-keyword">if</span>(rootpath) {
            <span class="hljs-keyword">var</span> root = rootpath.split(<span class="hljs-string">"/"</span>);
            <span class="hljs-comment">// Remove the filename part of the root</span>
            root.splice(root.length - <span class="hljs-number">1</span>, <span class="hljs-number">1</span>);
            <span class="hljs-keyword">return</span> root.join(<span class="hljs-string">"/"</span>) + <span class="hljs-string">"/"</span> + sourcepath;
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">return</span> sourcepath;
        }
    }
};

<span class="hljs-comment">/*
Parse a semantic version string into its constituent parts -- see https://semver.org
*/</span>
$tw.utils.parseVersion = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">version</span>) </span>{
    <span class="hljs-keyword">var</span> match = <span class="hljs-regexp">/^v?((\d+)\.(\d+)\.(\d+))(?:-([\dA-Za-z\-]+(?:\.[\dA-Za-z\-]+)*))?(?:\+([\dA-Za-z\-]+(?:\.[\dA-Za-z\-]+)*))?$/</span>.exec(version);
    <span class="hljs-keyword">if</span>(match) {
        <span class="hljs-keyword">return</span> {
            <span class="hljs-attr">version</span>: match[<span class="hljs-number">1</span>],
            <span class="hljs-attr">major</span>: <span class="hljs-built_in">parseInt</span>(match[<span class="hljs-number">2</span>],<span class="hljs-number">10</span>),
            <span class="hljs-attr">minor</span>: <span class="hljs-built_in">parseInt</span>(match[<span class="hljs-number">3</span>],<span class="hljs-number">10</span>),
            <span class="hljs-attr">patch</span>: <span class="hljs-built_in">parseInt</span>(match[<span class="hljs-number">4</span>],<span class="hljs-number">10</span>),
            <span class="hljs-attr">prerelease</span>: match[<span class="hljs-number">5</span>],
            <span class="hljs-attr">build</span>: match[<span class="hljs-number">6</span>]
        };
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    }
};

<span class="hljs-comment">/*
Returns +1 if the version string A is greater than the version string B, 0 if they are the same, and +1 if B is greater than A.
Missing or malformed version strings are parsed as 0.0.0
*/</span>
$tw.utils.compareVersions = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">versionStringA,versionStringB</span>) </span>{
    <span class="hljs-keyword">var</span> defaultVersion = {
            <span class="hljs-attr">major</span>: <span class="hljs-number">0</span>,
            <span class="hljs-attr">minor</span>: <span class="hljs-number">0</span>,
            <span class="hljs-attr">patch</span>: <span class="hljs-number">0</span>
        },
        versionA = $tw.utils.parseVersion(versionStringA) || defaultVersion,
        versionB = $tw.utils.parseVersion(versionStringB) || defaultVersion,
        diff = [
            versionA.major - versionB.major,
            versionA.minor - versionB.minor,
            versionA.patch - versionB.patch
        ];
    <span class="hljs-keyword">if</span>((diff[<span class="hljs-number">0</span>] &gt; <span class="hljs-number">0</span>) || (diff[<span class="hljs-number">0</span>] === <span class="hljs-number">0</span> &amp;&amp; diff[<span class="hljs-number">1</span>] &gt; <span class="hljs-number">0</span>) || (diff[<span class="hljs-number">0</span>] === <span class="hljs-number">0</span> &amp; diff[<span class="hljs-number">1</span>] === <span class="hljs-number">0</span> &amp; diff[<span class="hljs-number">2</span>] &gt; <span class="hljs-number">0</span>)) {
        <span class="hljs-keyword">return</span> +<span class="hljs-number">1</span>;
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>((diff[<span class="hljs-number">0</span>] &lt; <span class="hljs-number">0</span>) || (diff[<span class="hljs-number">0</span>] === <span class="hljs-number">0</span> &amp;&amp; diff[<span class="hljs-number">1</span>] &lt; <span class="hljs-number">0</span>) || (diff[<span class="hljs-number">0</span>] === <span class="hljs-number">0</span> &amp; diff[<span class="hljs-number">1</span>] === <span class="hljs-number">0</span> &amp; diff[<span class="hljs-number">2</span>] &lt; <span class="hljs-number">0</span>)) {
        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
    }
};

<span class="hljs-comment">/*
Returns true if the version string A is greater than the version string B. Returns true if the versions are the same
*/</span>
$tw.utils.checkVersions = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">versionStringA,versionStringB</span>) </span>{
    <span class="hljs-keyword">return</span> $tw.utils.compareVersions(versionStringA,versionStringB) !== <span class="hljs-number">-1</span>;
};

<span class="hljs-comment">/*
Register file type information
options: {flags: flags,deserializerType: deserializerType}
    flags:"image" for image types
    deserializerType: defaults to type if not specified
*/</span>
$tw.utils.registerFileType = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">type,encoding,extension,options</span>) </span>{
    options = options || {};
    <span class="hljs-keyword">if</span>($tw.utils.isArray(extension)) {
        $tw.utils.each(extension,<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">extension</span>) </span>{
            $tw.config.fileExtensionInfo[extension] = {<span class="hljs-attr">type</span>: type};
        });
        extension = extension[<span class="hljs-number">0</span>];
    } <span class="hljs-keyword">else</span> {
        $tw.config.fileExtensionInfo[extension] = {<span class="hljs-attr">type</span>: type};
    }
    $tw.config.contentTypeInfo[type] = {<span class="hljs-attr">encoding</span>: encoding, <span class="hljs-attr">extension</span>: extension, <span class="hljs-attr">flags</span>: options.flags || [], <span class="hljs-attr">deserializerType</span>: options.deserializerType || type};
};

<span class="hljs-comment">/*
Given an extension, always access the $tw.config.fileExtensionInfo
using a lowercase extension only.
*/</span>
$tw.utils.getFileExtensionInfo = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">ext</span>) </span>{
    <span class="hljs-keyword">return</span> ext ? $tw.config.fileExtensionInfo[ext.toLowerCase()] : <span class="hljs-literal">null</span>;
}

<span class="hljs-comment">/*
Given an extension, get the correct encoding for that file.
defaults to utf8
*/</span>
$tw.utils.getTypeEncoding = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">ext</span>) </span>{
    <span class="hljs-keyword">var</span> extensionInfo = $tw.utils.getFileExtensionInfo(ext),
        type = extensionInfo ? extensionInfo.type : <span class="hljs-literal">null</span>,
        typeInfo = type ? $tw.config.contentTypeInfo[type] : <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">return</span> typeInfo ? typeInfo.encoding : <span class="hljs-string">"utf8"</span>;
};

<span class="hljs-comment">/*
Run code globally with specified context variables in scope
*/</span>
$tw.utils.evalGlobal = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">code,context,filename</span>) </span>{
    <span class="hljs-keyword">var</span> contextCopy = $tw.utils.extend(<span class="hljs-built_in">Object</span>.create(<span class="hljs-literal">null</span>),context);
    <span class="hljs-comment">// Get the context variables as a pair of arrays of names and values</span>
    <span class="hljs-keyword">var</span> contextNames = [], contextValues = [];
    $tw.utils.each(contextCopy,<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">value,name</span>) </span>{
        contextNames.push(name);
        contextValues.push(value);
    });
    <span class="hljs-comment">// Add the code prologue and epilogue</span>
    code = <span class="hljs-string">"(function("</span> + contextNames.join(<span class="hljs-string">","</span>) + <span class="hljs-string">") {(function(){\n"</span> + code + <span class="hljs-string">"\n;})();\nreturn exports;\n})\n"</span>;
    <span class="hljs-comment">// Compile the code into a function</span>
    <span class="hljs-keyword">var</span> fn;
    <span class="hljs-keyword">if</span>($tw.browser) {
        fn = <span class="hljs-built_in">window</span>[<span class="hljs-string">"eval"</span>](code + <span class="hljs-string">"\n\n//# sourceURL="</span> + filename);
    } <span class="hljs-keyword">else</span> {
        fn = vm.runInThisContext(code,filename);
    }
    <span class="hljs-comment">// Call the function and return the exports</span>
    <span class="hljs-keyword">return</span> fn.apply(<span class="hljs-literal">null</span>,contextValues);
};

<span class="hljs-comment">/*
Run code in a sandbox with only the specified context variables in scope
*/</span>
$tw.utils.evalSandboxed = $tw.browser ? $tw.utils.evalGlobal : <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">code,context,filename</span>) </span>{
    <span class="hljs-keyword">var</span> sandbox = $tw.utils.extend(<span class="hljs-built_in">Object</span>.create(<span class="hljs-literal">null</span>),context);
    vm.runInNewContext(code,sandbox,filename);
    <span class="hljs-keyword">return</span> sandbox.exports;
};

<span class="hljs-comment">/*
Creates a PasswordPrompt object
*/</span>
$tw.utils.PasswordPrompt = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-comment">// Store of pending password prompts</span>
    <span class="hljs-keyword">this</span>.passwordPrompts = [];
    <span class="hljs-comment">// Create the wrapper</span>
    <span class="hljs-keyword">this</span>.promptWrapper = $tw.utils.domMaker(<span class="hljs-string">"div"</span>,{<span class="hljs-string">"class"</span>:<span class="hljs-string">"tc-password-wrapper"</span>});
    <span class="hljs-built_in">document</span>.body.appendChild(<span class="hljs-keyword">this</span>.promptWrapper);
    <span class="hljs-comment">// Hide the empty wrapper</span>
    <span class="hljs-keyword">this</span>.setWrapperDisplay();
};

<span class="hljs-comment">/*
Hides or shows the wrapper depending on whether there are any outstanding prompts
*/</span>
$tw.utils.PasswordPrompt.prototype.setWrapperDisplay = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.passwordPrompts.length) {
        <span class="hljs-keyword">this</span>.promptWrapper.style.display = <span class="hljs-string">"block"</span>;
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">this</span>.promptWrapper.style.display = <span class="hljs-string">"none"</span>;
    }
};

<span class="hljs-comment">/*
Adds a new password prompt. Options are:
submitText: text to use for submit button (defaults to "Login")
serviceName: text of the human readable service name
noUserName: set true to disable username prompt
canCancel: set true to enable a cancel button (callback called with null)
repeatPassword: set true to prompt for the password twice
callback: function to be called on submission with parameter of object {username:,password:}. Callback must return `true` to remove the password prompt
*/</span>
$tw.utils.PasswordPrompt.prototype.createPrompt = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">options</span>) </span>{
    <span class="hljs-comment">// Create and add the prompt to the DOM</span>
    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>,
        submitText = options.submitText || <span class="hljs-string">"Login"</span>,
        dm = $tw.utils.domMaker,
        children = [dm(<span class="hljs-string">"h1"</span>,{<span class="hljs-attr">text</span>: options.serviceName})];
    <span class="hljs-keyword">if</span>(!options.noUserName) {
        children.push(dm(<span class="hljs-string">"input"</span>,{
            <span class="hljs-attr">attributes</span>: {<span class="hljs-attr">type</span>: <span class="hljs-string">"text"</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">"username"</span>, <span class="hljs-attr">placeholder</span>: $tw.language.getString(<span class="hljs-string">"Encryption/Username"</span>)}
        }));
    }
    children.push(dm(<span class="hljs-string">"input"</span>,{
        <span class="hljs-attr">attributes</span>: {
            <span class="hljs-attr">type</span>: <span class="hljs-string">"password"</span>,
            <span class="hljs-attr">name</span>: <span class="hljs-string">"password"</span>,
            <span class="hljs-attr">placeholder</span>: ( $tw.language == <span class="hljs-literal">undefined</span> ? <span class="hljs-string">"Password"</span> : $tw.language.getString(<span class="hljs-string">"Encryption/Password"</span>) )
        }
    }));
    <span class="hljs-keyword">if</span>(options.repeatPassword) {
        children.push(dm(<span class="hljs-string">"input"</span>,{
            <span class="hljs-attr">attributes</span>: {
                <span class="hljs-attr">type</span>: <span class="hljs-string">"password"</span>,
                <span class="hljs-attr">name</span>: <span class="hljs-string">"password2"</span>,
                <span class="hljs-attr">placeholder</span>: $tw.language.getString(<span class="hljs-string">"Encryption/RepeatPassword"</span>)
            }
        }));
    }
    <span class="hljs-keyword">if</span>(options.canCancel) {
        children.push(dm(<span class="hljs-string">"button"</span>,{
            <span class="hljs-attr">text</span>: $tw.language.getString(<span class="hljs-string">"Encryption/Cancel"</span>),
            <span class="hljs-attr">attributes</span>: {
                <span class="hljs-attr">type</span>: <span class="hljs-string">"button"</span>
            },
            <span class="hljs-attr">eventListeners</span>: [{
                    <span class="hljs-attr">name</span>: <span class="hljs-string">"click"</span>,
                    <span class="hljs-attr">handlerFunction</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">event</span>) </span>{
                        self.removePrompt(promptInfo);
                        options.callback(<span class="hljs-literal">null</span>);
                    }
                }]
        }));
    }
    children.push(dm(<span class="hljs-string">"button"</span>,{
        <span class="hljs-attr">attributes</span>: {<span class="hljs-attr">type</span>: <span class="hljs-string">"submit"</span>},
        <span class="hljs-attr">text</span>: submitText
    }));
    <span class="hljs-keyword">var</span> form = dm(<span class="hljs-string">"form"</span>,{
        <span class="hljs-attr">attributes</span>: {<span class="hljs-attr">autocomplete</span>: <span class="hljs-string">"off"</span>},
        <span class="hljs-attr">children</span>: children
    });
    <span class="hljs-keyword">this</span>.promptWrapper.appendChild(form);
    <span class="hljs-built_in">window</span>.setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        form.elements[<span class="hljs-number">0</span>].focus();
    },<span class="hljs-number">10</span>);
    <span class="hljs-comment">// Add a submit event handler</span>
    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;
    form.addEventListener(<span class="hljs-string">"submit"</span>,<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">event</span>) </span>{
        <span class="hljs-comment">// Collect the form data</span>
        <span class="hljs-keyword">var</span> data = {},t;
        $tw.utils.each(form.elements,<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">element</span>) </span>{
            <span class="hljs-keyword">if</span>(element.name &amp;&amp; element.value) {
                data[element.name] = element.value;
            }
        });
        <span class="hljs-comment">// Check that the passwords match</span>
        <span class="hljs-keyword">if</span>(options.repeatPassword &amp;&amp; data.password !== data.password2) {
            alert($tw.language.getString(<span class="hljs-string">"Encryption/PasswordNoMatch"</span>));
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// Call the callback</span>
            <span class="hljs-keyword">if</span>(options.callback(data)) {
                <span class="hljs-comment">// Remove the prompt if the callback returned true</span>
                self.removePrompt(promptInfo);
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-comment">// Clear the password if the callback returned false</span>
                $tw.utils.each(form.elements,<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">element</span>) </span>{
                    <span class="hljs-keyword">if</span>(element.name === <span class="hljs-string">"password"</span> || element.name === <span class="hljs-string">"password2"</span>) {
                        element.value = <span class="hljs-string">""</span>;
                    }
                });
            }
        }
        event.preventDefault();
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    },<span class="hljs-literal">true</span>);
    <span class="hljs-comment">// Add the prompt to the list</span>
    <span class="hljs-keyword">var</span> promptInfo = {
        <span class="hljs-attr">serviceName</span>: options.serviceName,
        <span class="hljs-attr">callback</span>: options.callback,
        <span class="hljs-attr">form</span>: form,
        <span class="hljs-attr">owner</span>: <span class="hljs-keyword">this</span>
    };
    <span class="hljs-keyword">this</span>.passwordPrompts.push(promptInfo);
    <span class="hljs-comment">// Make sure the wrapper is displayed</span>
    <span class="hljs-keyword">this</span>.setWrapperDisplay();
    <span class="hljs-keyword">return</span> promptInfo;
};

$tw.utils.PasswordPrompt.prototype.removePrompt = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">promptInfo</span>) </span>{
    <span class="hljs-keyword">var</span> i = <span class="hljs-keyword">this</span>.passwordPrompts.indexOf(promptInfo);
    <span class="hljs-keyword">if</span>(i !== <span class="hljs-number">-1</span>) {
        <span class="hljs-keyword">this</span>.passwordPrompts.splice(i,<span class="hljs-number">1</span>);
        promptInfo.form.parentNode.removeChild(promptInfo.form);
        <span class="hljs-keyword">this</span>.setWrapperDisplay();
    }
}

<span class="hljs-comment">/*
Crypto helper object for encrypted content. It maintains the password text in a closure, and provides methods to change
the password, and to encrypt/decrypt a block of text
*/</span>
$tw.utils.Crypto = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> sjcl = $tw.node ? (global.sjcl || <span class="hljs-built_in">require</span>(<span class="hljs-string">"./sjcl.js"</span>)) : <span class="hljs-built_in">window</span>.sjcl,
        currentPassword = <span class="hljs-literal">null</span>,
        callSjcl = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">method,inputText,password</span>) </span>{
            password = password || currentPassword;
            <span class="hljs-keyword">var</span> outputText;
            <span class="hljs-keyword">try</span> {
                <span class="hljs-keyword">if</span>(password) {
                    outputText = sjcl[method](password,inputText);
                }
            } <span class="hljs-keyword">catch</span>(ex) {
                <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Crypto error:"</span> + ex);
                outputText = <span class="hljs-literal">null</span>;
            }
            <span class="hljs-keyword">return</span> outputText;
        };
    <span class="hljs-keyword">this</span>.setPassword = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">newPassword</span>) </span>{
        currentPassword = newPassword;
        <span class="hljs-keyword">this</span>.updateCryptoStateTiddler();
    };
    <span class="hljs-keyword">this</span>.updateCryptoStateTiddler = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">if</span>($tw.wiki) {
            <span class="hljs-keyword">var</span> state = currentPassword ? <span class="hljs-string">"yes"</span> : <span class="hljs-string">"no"</span>,
                tiddler = $tw.wiki.getTiddler(<span class="hljs-string">"$:/isEncrypted"</span>);
            <span class="hljs-keyword">if</span>(!tiddler || tiddler.fields.text !== state) {
                $tw.wiki.addTiddler(<span class="hljs-keyword">new</span> $tw.Tiddler({<span class="hljs-attr">title</span>: <span class="hljs-string">"$:/isEncrypted"</span>, <span class="hljs-attr">text</span>: state}));
            }
        }
    };
    <span class="hljs-keyword">this</span>.hasPassword = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">return</span> !!currentPassword;
    }
    <span class="hljs-keyword">this</span>.encrypt = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">text,password</span>) </span>{
        <span class="hljs-keyword">return</span> callSjcl(<span class="hljs-string">"encrypt"</span>,text,password);
    };
    <span class="hljs-keyword">this</span>.decrypt = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">text,password</span>) </span>{
        <span class="hljs-keyword">return</span> callSjcl(<span class="hljs-string">"decrypt"</span>,text,password);
    };
};

<span class="hljs-comment">/////////////////////////// Module mechanism</span>

<span class="hljs-comment">/*
Execute the module named 'moduleName'. The name can optionally be relative to the module named 'moduleRoot'
*/</span>
$tw.modules.execute = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">moduleName,moduleRoot</span>) </span>{
    <span class="hljs-keyword">var</span> name = moduleName;
    <span class="hljs-keyword">if</span>(moduleName.charAt(<span class="hljs-number">0</span>) === <span class="hljs-string">"."</span>) {
        name = $tw.utils.resolvePath(moduleName,moduleRoot)
    }
    <span class="hljs-keyword">if</span>(!$tw.modules.titles[name]) {
        <span class="hljs-keyword">if</span>($tw.modules.titles[name + <span class="hljs-string">".js"</span>]) {
            name = name + <span class="hljs-string">".js"</span>;
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>($tw.modules.titles[name + <span class="hljs-string">"/index.js"</span>]) {
            name = name + <span class="hljs-string">"/index.js"</span>;
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>($tw.modules.titles[moduleName]) {
            name = moduleName;
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>($tw.modules.titles[moduleName + <span class="hljs-string">".js"</span>]) {
            name = moduleName + <span class="hljs-string">".js"</span>;
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>($tw.modules.titles[moduleName + <span class="hljs-string">"/index.js"</span>]) {
            name = moduleName + <span class="hljs-string">"/index.js"</span>;
        }
    }
    <span class="hljs-keyword">var</span> moduleInfo = $tw.modules.titles[name],
        tiddler = $tw.wiki.getTiddler(name),
        _exports = {},
        sandbox = {
            <span class="hljs-attr">module</span>: {<span class="hljs-attr">exports</span>: _exports},
            <span class="hljs-comment">//moduleInfo: moduleInfo,</span>
            <span class="hljs-attr">exports</span>: _exports,
            <span class="hljs-attr">console</span>: <span class="hljs-built_in">console</span>,
            <span class="hljs-attr">setInterval</span>: setInterval,
            <span class="hljs-attr">clearInterval</span>: clearInterval,
            <span class="hljs-attr">setTimeout</span>: setTimeout,
            <span class="hljs-attr">clearTimeout</span>: clearTimeout,
            <span class="hljs-attr">Buffer</span>: $tw.browser ? <span class="hljs-literal">undefined</span> : Buffer,
            <span class="hljs-attr">$tw</span>: $tw,
            <span class="hljs-attr">require</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">title</span>) </span>{
                <span class="hljs-keyword">return</span> $tw.modules.execute(title, name);
            }
        };

    <span class="hljs-built_in">Object</span>.defineProperty(sandbox.module, <span class="hljs-string">"id"</span>, {
        <span class="hljs-attr">value</span>: name,
        <span class="hljs-attr">writable</span>: <span class="hljs-literal">false</span>,
        <span class="hljs-attr">enumerable</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">configurable</span>: <span class="hljs-literal">false</span>
    });

    <span class="hljs-keyword">if</span>(!$tw.browser) {
        $tw.utils.extend(sandbox,{
            <span class="hljs-attr">process</span>: process
        });
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">/*
        CommonJS optional require.main property:
         In a browser we offer a fake main module which points back to the boot function
         (Theoretically, this may allow TW to eventually load itself as a module in the browser)
        */</span>
        <span class="hljs-built_in">Object</span>.defineProperty(sandbox.require, <span class="hljs-string">"main"</span>, {
            <span class="hljs-attr">value</span>: (<span class="hljs-keyword">typeof</span>(<span class="hljs-built_in">require</span>) !== <span class="hljs-string">"undefined"</span>) ? <span class="hljs-built_in">require</span>.main : {<span class="hljs-attr">TiddlyWiki</span>: _boot},
            <span class="hljs-attr">writable</span>: <span class="hljs-literal">false</span>,
            <span class="hljs-attr">enumerable</span>: <span class="hljs-literal">true</span>,
            <span class="hljs-attr">configurable</span>: <span class="hljs-literal">false</span>
        });
    }
    <span class="hljs-keyword">if</span>(!moduleInfo) {
        <span class="hljs-comment">// We could not find the module on this path</span>
        <span class="hljs-comment">// Try to defer to browserify etc, or node</span>
        <span class="hljs-keyword">var</span> deferredModule;
        <span class="hljs-keyword">if</span>($tw.browser) {
            <span class="hljs-keyword">if</span>(<span class="hljs-built_in">window</span>.require) {
                <span class="hljs-keyword">try</span> {
                    <span class="hljs-keyword">return</span> <span class="hljs-built_in">window</span>.require(moduleName);
                } <span class="hljs-keyword">catch</span>(e) {}
            }
            <span class="hljs-keyword">throw</span> <span class="hljs-string">"Cannot find module named '"</span> + moduleName + <span class="hljs-string">"' required by module '"</span> + moduleRoot + <span class="hljs-string">"', resolved to "</span> + name;
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// If we don't have a module with that name, let node.js try to find it</span>
            <span class="hljs-keyword">return</span> <span class="hljs-built_in">require</span>(moduleName);
        }
    }
    <span class="hljs-comment">// Execute the module if we haven't already done so</span>
    <span class="hljs-keyword">if</span>(!moduleInfo.exports) {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// Check the type of the definition</span>
            <span class="hljs-keyword">if</span>(<span class="hljs-keyword">typeof</span> moduleInfo.definition === <span class="hljs-string">"function"</span>) { <span class="hljs-comment">// Function</span>
                moduleInfo.exports = _exports;
                moduleInfo.definition(moduleInfo,moduleInfo.exports,sandbox.require);
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-keyword">typeof</span> moduleInfo.definition === <span class="hljs-string">"string"</span>) { <span class="hljs-comment">// String</span>
                moduleInfo.exports = _exports;
                $tw.utils.evalSandboxed(moduleInfo.definition,sandbox,tiddler.fields.title);
                <span class="hljs-keyword">if</span>(sandbox.module.exports) {
                    moduleInfo.exports = sandbox.module.exports; <span class="hljs-comment">//more codemirror workaround</span>
                }
            } <span class="hljs-keyword">else</span> { <span class="hljs-comment">// Object</span>
                moduleInfo.exports = moduleInfo.definition;
            }
        } <span class="hljs-keyword">catch</span>(e) {
            <span class="hljs-keyword">if</span> (e <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">SyntaxError</span>) {
                <span class="hljs-keyword">var</span> line = e.lineNumber || e.line; <span class="hljs-comment">// Firefox || Safari</span>
                <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span>(line) != <span class="hljs-string">"undefined"</span> &amp;&amp; line !== <span class="hljs-literal">null</span>) {
                    $tw.utils.error(<span class="hljs-string">"Syntax error in boot module "</span> + name + <span class="hljs-string">":"</span> + line + <span class="hljs-string">":\n"</span> + e.stack);
                } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(!$tw.browser) {
                    <span class="hljs-comment">// this is the only way to get node.js to display the line at which the syntax error appeared,</span>
                    <span class="hljs-comment">// and $tw.utils.error would exit anyway</span>
                    <span class="hljs-comment">// cf. https://bugs.chromium.org/p/v8/issues/detail?id=2589</span>
                    <span class="hljs-keyword">throw</span> e;
                } <span class="hljs-keyword">else</span> {
                    <span class="hljs-comment">// Opera: line number is included in e.message</span>
                    <span class="hljs-comment">// Chrome/IE: there's currently no way to get the line number</span>
                    $tw.utils.error(<span class="hljs-string">"Syntax error in boot module "</span> + name + <span class="hljs-string">": "</span> + e.message + <span class="hljs-string">"\n"</span> + e.stack);
                }
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-comment">// line number should be included in e.stack for runtime errors</span>
                $tw.utils.error(<span class="hljs-string">"Error executing boot module "</span> + name + <span class="hljs-string">": "</span> + <span class="hljs-built_in">JSON</span>.stringify(e) + <span class="hljs-string">"\n\n"</span> + e.stack);
            }
        }
    }
    <span class="hljs-comment">// Return the exports of the module</span>
    <span class="hljs-keyword">return</span> moduleInfo.exports;
};

<span class="hljs-comment">/*
Apply a callback to each module of a particular type
    moduleType: type of modules to enumerate
    callback: function called as callback(title,moduleExports) for each module
*/</span>
$tw.modules.forEachModuleOfType = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">moduleType,callback</span>) </span>{
    <span class="hljs-keyword">var</span> modules = $tw.modules.types[moduleType];
    $tw.utils.each(modules,<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">element,title</span>) </span>{
        callback(title,$tw.modules.execute(title));
    });
};

<span class="hljs-comment">/*
Get all the modules of a particular type in a hashmap by their `name` field
*/</span>
$tw.modules.getModulesByTypeAsHashmap = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">moduleType,nameField</span>) </span>{
    nameField = nameField || <span class="hljs-string">"name"</span>;
    <span class="hljs-keyword">var</span> results = <span class="hljs-built_in">Object</span>.create(<span class="hljs-literal">null</span>);
    $tw.modules.forEachModuleOfType(moduleType,<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">title,module</span>) </span>{
        results[<span class="hljs-built_in">module</span>[nameField]] = <span class="hljs-built_in">module</span>;
    });
    <span class="hljs-keyword">return</span> results;
};

<span class="hljs-comment">/*
Apply the exports of the modules of a particular type to a target object
*/</span>
$tw.modules.applyMethods = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">moduleType,targetObject</span>) </span>{
    <span class="hljs-keyword">if</span>(!targetObject) {
        targetObject = <span class="hljs-built_in">Object</span>.create(<span class="hljs-literal">null</span>);
    }
    $tw.modules.forEachModuleOfType(moduleType,<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">title,module</span>) </span>{
        $tw.utils.each(<span class="hljs-built_in">module</span>,<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">element,title,object</span>) </span>{
            targetObject[title] = <span class="hljs-built_in">module</span>[title];
        });
    });
    <span class="hljs-keyword">return</span> targetObject;
};

<span class="hljs-comment">/*
Return a class created from a modules. The module should export the properties to be added to those of the optional base class
*/</span>
$tw.modules.createClassFromModule = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">moduleExports,baseClass</span>) </span>{
    <span class="hljs-keyword">var</span> newClass = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{};
    <span class="hljs-keyword">if</span>(baseClass) {
        newClass.prototype = <span class="hljs-keyword">new</span> baseClass();
        newClass.prototype.constructor = baseClass;
    }
    $tw.utils.extend(newClass.prototype,moduleExports);
    <span class="hljs-keyword">return</span> newClass;
};

<span class="hljs-comment">/*
Return an array of classes created from the modules of a specified type. Each module should export the properties to be added to those of the optional base class
*/</span>
$tw.modules.createClassesFromModules = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">moduleType,subType,baseClass</span>) </span>{
    <span class="hljs-keyword">var</span> classes = <span class="hljs-built_in">Object</span>.create(<span class="hljs-literal">null</span>);
    $tw.modules.forEachModuleOfType(moduleType,<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">title,moduleExports</span>) </span>{
        <span class="hljs-keyword">if</span>(!subType || moduleExports.types[subType]) {
            classes[moduleExports.name] = $tw.modules.createClassFromModule(moduleExports,baseClass);
        }
    });
    <span class="hljs-keyword">return</span> classes;
};

<span class="hljs-comment">/////////////////////////// Barebones tiddler object</span>

<span class="hljs-comment">/*
Construct a tiddler object from a hashmap of tiddler fields. If multiple hasmaps are provided they are merged,
taking precedence to the right
*/</span>
$tw.Tiddler = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"><span class="hljs-regexp">/* [fields,] fields */</span></span>) </span>{
    <span class="hljs-keyword">this</span>.fields = <span class="hljs-built_in">Object</span>.create(<span class="hljs-literal">null</span>);
    <span class="hljs-keyword">this</span>.cache = <span class="hljs-built_in">Object</span>.create(<span class="hljs-literal">null</span>);
    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> c=<span class="hljs-number">0</span>; c&lt;<span class="hljs-built_in">arguments</span>.length; c++) {
        <span class="hljs-keyword">var</span> arg = <span class="hljs-built_in">arguments</span>[c],
            src = (arg <span class="hljs-keyword">instanceof</span> $tw.Tiddler) ? arg.fields : arg;
        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> t <span class="hljs-keyword">in</span> src) {
            <span class="hljs-keyword">if</span>(src[t] === <span class="hljs-literal">undefined</span> || src[t] === <span class="hljs-literal">null</span>) {
                <span class="hljs-keyword">if</span>(t <span class="hljs-keyword">in</span> <span class="hljs-keyword">this</span>.fields) {
                    <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>.fields[t]; <span class="hljs-comment">// If we get a field that's undefined, delete any previous field value</span>
                }
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-comment">// Parse the field with the associated field module (if any)</span>
                <span class="hljs-keyword">var</span> fieldModule = $tw.Tiddler.fieldModules[t],
                    value;
                <span class="hljs-keyword">if</span>(fieldModule &amp;&amp; fieldModule.parse) {
                    value = fieldModule.parse.call(<span class="hljs-keyword">this</span>,src[t]);
                } <span class="hljs-keyword">else</span> {
                    value = src[t];
                }
                <span class="hljs-comment">// Freeze the field to keep it immutable</span>
                <span class="hljs-keyword">if</span>(value != <span class="hljs-literal">null</span> &amp;&amp; <span class="hljs-keyword">typeof</span> value === <span class="hljs-string">"object"</span>) {
                    <span class="hljs-built_in">Object</span>.freeze(value);
                }
                <span class="hljs-keyword">this</span>.fields[t] = value;
            }
        }
    }
    <span class="hljs-comment">// Freeze the tiddler against modification</span>
    <span class="hljs-built_in">Object</span>.freeze(<span class="hljs-keyword">this</span>.fields);
    <span class="hljs-built_in">Object</span>.freeze(<span class="hljs-keyword">this</span>);
};

$tw.Tiddler.prototype.hasField = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">field</span>) </span>{
    <span class="hljs-keyword">return</span> $tw.utils.hop(<span class="hljs-keyword">this</span>.fields,field);
};

<span class="hljs-comment">/*
Compare two tiddlers for equality
tiddler: the tiddler to compare
excludeFields: array of field names to exclude from the comparison
*/</span>
$tw.Tiddler.prototype.isEqual = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">tiddler,excludeFields</span>) </span>{
    <span class="hljs-keyword">if</span>(!(tiddler <span class="hljs-keyword">instanceof</span> $tw.Tiddler)) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
    excludeFields = excludeFields || [];
    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>,
        differences = []; <span class="hljs-comment">// Fields that have differences</span>
    <span class="hljs-comment">// Add to the differences array</span>
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">addDifference</span>(<span class="hljs-params">fieldName</span>) </span>{
        <span class="hljs-comment">// Check for this field being excluded</span>
        <span class="hljs-keyword">if</span>(excludeFields.indexOf(fieldName) === <span class="hljs-number">-1</span>) {
            <span class="hljs-comment">// Save the field as a difference</span>
            $tw.utils.pushTop(differences,fieldName);
        }
    }
    <span class="hljs-comment">// Returns true if the two values of this field are equal</span>
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">isFieldValueEqual</span>(<span class="hljs-params">fieldName</span>) </span>{
        <span class="hljs-keyword">var</span> valueA = self.fields[fieldName],
            valueB = tiddler.fields[fieldName];
        <span class="hljs-comment">// Check for identical string values</span>
        <span class="hljs-keyword">if</span>(<span class="hljs-keyword">typeof</span>(valueA) === <span class="hljs-string">"string"</span> &amp;&amp; <span class="hljs-keyword">typeof</span>(valueB) === <span class="hljs-string">"string"</span> &amp;&amp; valueA === valueB) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        }
        <span class="hljs-comment">// Check for identical array values</span>
        <span class="hljs-keyword">if</span>($tw.utils.isArray(valueA) &amp;&amp; $tw.utils.isArray(valueB) &amp;&amp; $tw.utils.isArrayEqual(valueA,valueB)) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        }
        <span class="hljs-comment">// Check for identical date values</span>
        <span class="hljs-keyword">if</span>($tw.utils.isDate(valueA) &amp;&amp; $tw.utils.isDate(valueB) &amp;&amp; valueA.getTime() === valueB.getTime()) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        }
        <span class="hljs-comment">// Otherwise the fields must be different</span>
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
    <span class="hljs-comment">// Compare our fields</span>
    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> fieldName <span class="hljs-keyword">in</span> <span class="hljs-keyword">this</span>.fields) {
        <span class="hljs-keyword">if</span>(!isFieldValueEqual(fieldName)) {
            addDifference(fieldName);
        }
    }
    <span class="hljs-comment">// There's a difference for every field in the other tiddler that we don't have</span>
    <span class="hljs-keyword">for</span>(fieldName <span class="hljs-keyword">in</span> tiddler.fields) {
        <span class="hljs-keyword">if</span>(!(fieldName <span class="hljs-keyword">in</span> <span class="hljs-keyword">this</span>.fields)) {
            addDifference(fieldName);
        }
    }
    <span class="hljs-comment">// Return whether there were any differences</span>
    <span class="hljs-keyword">return</span> differences.length === <span class="hljs-number">0</span>;
};

<span class="hljs-comment">/*
Register and install the built in tiddler field modules
*/</span>
$tw.modules.define(<span class="hljs-string">"$:/boot/tiddlerfields/modified"</span>,<span class="hljs-string">"tiddlerfield"</span>,{
    <span class="hljs-attr">name</span>: <span class="hljs-string">"modified"</span>,
    <span class="hljs-attr">parse</span>: $tw.utils.parseDate,
    <span class="hljs-attr">stringify</span>: $tw.utils.stringifyDate
});
$tw.modules.define(<span class="hljs-string">"$:/boot/tiddlerfields/created"</span>,<span class="hljs-string">"tiddlerfield"</span>,{
    <span class="hljs-attr">name</span>: <span class="hljs-string">"created"</span>,
    <span class="hljs-attr">parse</span>: $tw.utils.parseDate,
    <span class="hljs-attr">stringify</span>: $tw.utils.stringifyDate
});
$tw.modules.define(<span class="hljs-string">"$:/boot/tiddlerfields/color"</span>,<span class="hljs-string">"tiddlerfield"</span>,{
    <span class="hljs-attr">name</span>: <span class="hljs-string">"color"</span>,
    <span class="hljs-attr">editTag</span>: <span class="hljs-string">"input"</span>,
    <span class="hljs-attr">editType</span>: <span class="hljs-string">"color"</span>
});
$tw.modules.define(<span class="hljs-string">"$:/boot/tiddlerfields/tags"</span>,<span class="hljs-string">"tiddlerfield"</span>,{
    <span class="hljs-attr">name</span>: <span class="hljs-string">"tags"</span>,
    <span class="hljs-attr">parse</span>: $tw.utils.parseStringArray,
    <span class="hljs-attr">stringify</span>: $tw.utils.stringifyList
});
$tw.modules.define(<span class="hljs-string">"$:/boot/tiddlerfields/list"</span>,<span class="hljs-string">"tiddlerfield"</span>,{
    <span class="hljs-attr">name</span>: <span class="hljs-string">"list"</span>,
    <span class="hljs-attr">parse</span>: $tw.utils.parseStringArray,
    <span class="hljs-attr">stringify</span>: $tw.utils.stringifyList
});

<span class="hljs-comment">/////////////////////////// Barebones wiki store</span>

<span class="hljs-comment">/*
Wiki constructor. State is stored in private members that only a small number of privileged accessor methods have direct access. Methods added via the prototype have to use these accessors and cannot access the state data directly.
options include:
enableIndexers - Array of indexer names to enable, or null to use all available indexers
*/</span>
$tw.Wiki = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">options</span>) </span>{
    options = options || {};
    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>,
        tiddlers = <span class="hljs-built_in">Object</span>.create(<span class="hljs-literal">null</span>), <span class="hljs-comment">// Hashmap of tiddlers</span>
        tiddlerTitles = <span class="hljs-literal">null</span>, <span class="hljs-comment">// Array of tiddler titles</span>
        getTiddlerTitles = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            <span class="hljs-keyword">if</span>(!tiddlerTitles) {
                tiddlerTitles = <span class="hljs-built_in">Object</span>.keys(tiddlers);
            }
            <span class="hljs-keyword">return</span> tiddlerTitles;
        },
        pluginTiddlers = [], <span class="hljs-comment">// Array of tiddlers containing registered plugins, ordered by priority</span>
        pluginInfo = <span class="hljs-built_in">Object</span>.create(<span class="hljs-literal">null</span>), <span class="hljs-comment">// Hashmap of parsed plugin content</span>
        shadowTiddlers = <span class="hljs-built_in">Object</span>.create(<span class="hljs-literal">null</span>), <span class="hljs-comment">// Hashmap by title of {source:, tiddler:}</span>
        shadowTiddlerTitles = <span class="hljs-literal">null</span>,
        getShadowTiddlerTitles = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            <span class="hljs-keyword">if</span>(!shadowTiddlerTitles) {
                shadowTiddlerTitles = <span class="hljs-built_in">Object</span>.keys(shadowTiddlers);
            }
            <span class="hljs-keyword">return</span> shadowTiddlerTitles;
        },
        enableIndexers = options.enableIndexers || <span class="hljs-literal">null</span>,
        indexers = [],
        indexersByName = <span class="hljs-built_in">Object</span>.create(<span class="hljs-literal">null</span>);

    <span class="hljs-keyword">this</span>.addIndexer = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">indexer,name</span>) </span>{
        <span class="hljs-comment">// Bail if this indexer is not enabled</span>
        <span class="hljs-keyword">if</span>(enableIndexers &amp;&amp; enableIndexers.indexOf(name) === <span class="hljs-number">-1</span>) {
            <span class="hljs-keyword">return</span>;
        }
        indexers.push(indexer);
        indexersByName[name] = indexer;
        indexer.init();
    };

    <span class="hljs-keyword">this</span>.getIndexer = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">name</span>) </span>{
        <span class="hljs-keyword">return</span> indexersByName[name] || <span class="hljs-literal">null</span>;
    };

    <span class="hljs-comment">// Add a tiddler to the store</span>
    <span class="hljs-keyword">this</span>.addTiddler = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">tiddler</span>) </span>{
        <span class="hljs-keyword">if</span>(!(tiddler <span class="hljs-keyword">instanceof</span> $tw.Tiddler)) {
            tiddler = <span class="hljs-keyword">new</span> $tw.Tiddler(tiddler);
        }
        <span class="hljs-comment">// Save the tiddler</span>
        <span class="hljs-keyword">if</span>(tiddler) {
            <span class="hljs-keyword">var</span> title = tiddler.fields.title;
            <span class="hljs-keyword">if</span>(title) {
<span class="hljs-comment">// Uncomment the following line for detailed logs of all tiddler writes</span>
<span class="hljs-comment">// console.log("Adding",title,tiddler)</span>
                <span class="hljs-comment">// Record the old tiddler state</span>
                <span class="hljs-keyword">var</span> updateDescriptor = {
                    <span class="hljs-attr">old</span>: {
                        <span class="hljs-attr">tiddler</span>: <span class="hljs-keyword">this</span>.getTiddler(title),
                        <span class="hljs-attr">shadow</span>: <span class="hljs-keyword">this</span>.isShadowTiddler(title),
                        <span class="hljs-attr">exists</span>: <span class="hljs-keyword">this</span>.tiddlerExists(title)
                    }
                }
                <span class="hljs-comment">// Save the new tiddler</span>
                tiddlers[title] = tiddler;
                <span class="hljs-comment">// Check we've got it's title</span>
                <span class="hljs-keyword">if</span>(tiddlerTitles &amp;&amp; tiddlerTitles.indexOf(title) === <span class="hljs-number">-1</span>) {
                    tiddlerTitles.push(title);
                }
                <span class="hljs-comment">// Record the new tiddler state</span>
                updateDescriptor[<span class="hljs-string">"new"</span>] = {
                    <span class="hljs-attr">tiddler</span>: tiddler,
                    <span class="hljs-attr">shadow</span>: <span class="hljs-keyword">this</span>.isShadowTiddler(title),
                    <span class="hljs-attr">exists</span>: <span class="hljs-keyword">this</span>.tiddlerExists(title)
                }
                <span class="hljs-comment">// Update indexes</span>
                <span class="hljs-keyword">this</span>.clearCache(title);
                <span class="hljs-keyword">this</span>.clearGlobalCache();
                $tw.utils.each(indexers,<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">indexer</span>) </span>{
                    indexer.update(updateDescriptor);
                });
                <span class="hljs-comment">// Queue a change event</span>
                <span class="hljs-keyword">this</span>.enqueueTiddlerEvent(title);
            }
        }
    };

    <span class="hljs-comment">// Delete a tiddler</span>
    <span class="hljs-keyword">this</span>.deleteTiddler = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">title</span>) </span>{
<span class="hljs-comment">// Uncomment the following line for detailed logs of all tiddler deletions</span>
<span class="hljs-comment">// console.log("Deleting",title)</span>
        <span class="hljs-keyword">if</span>($tw.utils.hop(tiddlers,title)) {
            <span class="hljs-comment">// Record the old tiddler state</span>
            <span class="hljs-keyword">var</span> updateDescriptor = {
                <span class="hljs-attr">old</span>: {
                    <span class="hljs-attr">tiddler</span>: <span class="hljs-keyword">this</span>.getTiddler(title),
                    <span class="hljs-attr">shadow</span>: <span class="hljs-keyword">this</span>.isShadowTiddler(title),
                    <span class="hljs-attr">exists</span>: <span class="hljs-keyword">this</span>.tiddlerExists(title)
                }
            }
            <span class="hljs-comment">// Delete the tiddler</span>
            <span class="hljs-keyword">delete</span> tiddlers[title];
            <span class="hljs-comment">// Delete it from the list of titles</span>
            <span class="hljs-keyword">if</span>(tiddlerTitles) {
                <span class="hljs-keyword">var</span> index = tiddlerTitles.indexOf(title);
                <span class="hljs-keyword">if</span>(index !== <span class="hljs-number">-1</span>) {
                    tiddlerTitles.splice(index,<span class="hljs-number">1</span>);
                }
            }
            <span class="hljs-comment">// Record the new tiddler state</span>
            updateDescriptor[<span class="hljs-string">"new"</span>] = {
                <span class="hljs-attr">tiddler</span>: <span class="hljs-keyword">this</span>.getTiddler(title),
                <span class="hljs-attr">shadow</span>: <span class="hljs-keyword">this</span>.isShadowTiddler(title),
                <span class="hljs-attr">exists</span>: <span class="hljs-keyword">this</span>.tiddlerExists(title)
            }
            <span class="hljs-comment">// Update indexes</span>
            <span class="hljs-keyword">this</span>.clearCache(title);
            <span class="hljs-keyword">this</span>.clearGlobalCache();
            $tw.utils.each(indexers,<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">indexer</span>) </span>{
                indexer.update(updateDescriptor);
            });
            <span class="hljs-comment">// Queue a change event</span>
            <span class="hljs-keyword">this</span>.enqueueTiddlerEvent(title,<span class="hljs-literal">true</span>);
        }
    };

    <span class="hljs-comment">// Get a tiddler from the store</span>
    <span class="hljs-keyword">this</span>.getTiddler = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">title</span>) </span>{
        <span class="hljs-keyword">if</span>(title) {
            <span class="hljs-keyword">var</span> t = tiddlers[title];
            <span class="hljs-keyword">if</span>(t <span class="hljs-keyword">instanceof</span> $tw.Tiddler) {
                <span class="hljs-keyword">return</span> t;
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(title !== <span class="hljs-literal">undefined</span> &amp;&amp; shadowTiddlers[title]) {
                <span class="hljs-keyword">return</span> shadowTiddlers[title].tiddler;
            }
            <span class="hljs-keyword">return</span> <span class="hljs-literal">undefined</span>;
        }
    };

    <span class="hljs-comment">// Get an array of all tiddler titles</span>
    <span class="hljs-keyword">this</span>.allTitles = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">return</span> getTiddlerTitles().slice(<span class="hljs-number">0</span>);
    };

    <span class="hljs-comment">// Iterate through all tiddler titles</span>
    <span class="hljs-keyword">this</span>.each = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">callback</span>) </span>{
        <span class="hljs-keyword">var</span> titles = getTiddlerTitles(),
            index,titlesLength,title;
        <span class="hljs-keyword">for</span>(index = <span class="hljs-number">0</span>, titlesLength = titles.length; index &lt; titlesLength; index++) {
            title = titles[index];
            callback(tiddlers[title],title);
        }
    };

    <span class="hljs-comment">// Get an array of all shadow tiddler titles</span>
    <span class="hljs-keyword">this</span>.allShadowTitles = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">return</span> getShadowTiddlerTitles().slice(<span class="hljs-number">0</span>);
    };

    <span class="hljs-comment">// Iterate through all shadow tiddler titles</span>
    <span class="hljs-keyword">this</span>.eachShadow = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">callback</span>) </span>{
        <span class="hljs-keyword">var</span> titles = getShadowTiddlerTitles(),
            index,titlesLength,title;
        <span class="hljs-keyword">for</span>(index = <span class="hljs-number">0</span>, titlesLength = titles.length; index &lt; titlesLength; index++) {
            title = titles[index];
            <span class="hljs-keyword">if</span>(tiddlers[title]) {
                callback(tiddlers[title],title);
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">var</span> shadowInfo = shadowTiddlers[title];
                callback(shadowInfo.tiddler,title);
            }
        }
    };

    <span class="hljs-comment">// Iterate through all tiddlers and then the shadows</span>
    <span class="hljs-keyword">this</span>.eachTiddlerPlusShadows = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">callback</span>) </span>{
        <span class="hljs-keyword">var</span> index,titlesLength,title,
            titles = getTiddlerTitles();
        <span class="hljs-keyword">for</span>(index = <span class="hljs-number">0</span>, titlesLength = titles.length; index &lt; titlesLength; index++) {
            title = titles[index];
            callback(tiddlers[title],title);
        }
        titles = getShadowTiddlerTitles();
        <span class="hljs-keyword">for</span>(index = <span class="hljs-number">0</span>, titlesLength = titles.length; index &lt; titlesLength; index++) {
            title = titles[index];
            <span class="hljs-keyword">if</span>(!tiddlers[title]) {
                <span class="hljs-keyword">var</span> shadowInfo = shadowTiddlers[title];
                callback(shadowInfo.tiddler,title);
            }
        }
    };

    <span class="hljs-comment">// Iterate through all the shadows and then the tiddlers</span>
    <span class="hljs-keyword">this</span>.eachShadowPlusTiddlers = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">callback</span>) </span>{
        <span class="hljs-keyword">var</span> index,titlesLength,title,
            titles = getShadowTiddlerTitles();
        <span class="hljs-keyword">for</span>(index = <span class="hljs-number">0</span>, titlesLength = titles.length; index &lt; titlesLength; index++) {
            title = titles[index];
            <span class="hljs-keyword">if</span>(tiddlers[title]) {
                callback(tiddlers[title],title);
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">var</span> shadowInfo = shadowTiddlers[title];
                callback(shadowInfo.tiddler,title);
            }
        }
        titles = getTiddlerTitles();
        <span class="hljs-keyword">for</span>(index = <span class="hljs-number">0</span>, titlesLength = titles.length; index &lt; titlesLength; index++) {
            title = titles[index];
            <span class="hljs-keyword">if</span>(!shadowTiddlers[title]) {
                callback(tiddlers[title],title);
            }
        }
    };

    <span class="hljs-comment">// Test for the existence of a tiddler (excludes shadow tiddlers)</span>
    <span class="hljs-keyword">this</span>.tiddlerExists = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">title</span>) </span>{
        <span class="hljs-keyword">return</span> !!$tw.utils.hop(tiddlers,title);
    };

    <span class="hljs-comment">// Determines if a tiddler is a shadow tiddler, regardless of whether it has been overridden by a real tiddler</span>
    <span class="hljs-keyword">this</span>.isShadowTiddler = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">title</span>) </span>{
        <span class="hljs-keyword">return</span> $tw.utils.hop(shadowTiddlers,title);
    };

    <span class="hljs-keyword">this</span>.getShadowSource = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">title</span>) </span>{
        <span class="hljs-keyword">if</span>($tw.utils.hop(shadowTiddlers,title)) {
            <span class="hljs-keyword">return</span> shadowTiddlers[title].source;
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    };

    <span class="hljs-comment">// Get an array of all the currently recognised plugin types</span>
    <span class="hljs-keyword">this</span>.getPluginTypes = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">var</span> types = [];
        $tw.utils.each(pluginTiddlers,<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">pluginTiddler</span>) </span>{
            <span class="hljs-keyword">var</span> pluginType = pluginTiddler.fields[<span class="hljs-string">"plugin-type"</span>];
            <span class="hljs-keyword">if</span>(pluginType &amp;&amp; types.indexOf(pluginType) === <span class="hljs-number">-1</span>) {
                types.push(pluginType);
            }
        });
        <span class="hljs-keyword">return</span> types;
    };

    <span class="hljs-comment">// Read plugin info for all plugins, or just an array of titles. Returns the number of plugins updated or deleted</span>
    <span class="hljs-keyword">this</span>.readPluginInfo = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">titles</span>) </span>{
        <span class="hljs-keyword">var</span> results = {
            <span class="hljs-attr">modifiedPlugins</span>: [],
            <span class="hljs-attr">deletedPlugins</span>: []
        };
        $tw.utils.each(titles || getTiddlerTitles(),<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">title</span>) </span>{
            <span class="hljs-keyword">var</span> tiddler = tiddlers[title];
            <span class="hljs-keyword">if</span>(tiddler) {
                <span class="hljs-keyword">if</span>(tiddler.fields.type === <span class="hljs-string">"application/json"</span> &amp;&amp; tiddler.hasField(<span class="hljs-string">"plugin-type"</span>) &amp;&amp; tiddler.fields.text) {
                    pluginInfo[tiddler.fields.title] = <span class="hljs-built_in">JSON</span>.parse(tiddler.fields.text);
                    results.modifiedPlugins.push(tiddler.fields.title);
                }
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">if</span>(pluginInfo[title]) {
                    <span class="hljs-keyword">delete</span> pluginInfo[title];
                    results.deletedPlugins.push(title);
                }
            }
        });
        <span class="hljs-keyword">return</span> results;
    };

    <span class="hljs-comment">// Get plugin info for a plugin</span>
    <span class="hljs-keyword">this</span>.getPluginInfo = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">title</span>) </span>{
        <span class="hljs-keyword">return</span> pluginInfo[title];
    };

    <span class="hljs-comment">// Register the plugin tiddlers of a particular type, or null/undefined for any type, optionally restricting registration to an array of tiddler titles. Return the array of titles affected</span>
    <span class="hljs-keyword">this</span>.registerPluginTiddlers = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">pluginType,titles</span>) </span>{
        <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>,
            registeredTitles = [],
            checkTiddler = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">tiddler,title</span>) </span>{
                <span class="hljs-keyword">if</span>(tiddler &amp;&amp; tiddler.fields.type === <span class="hljs-string">"application/json"</span> &amp;&amp; tiddler.fields[<span class="hljs-string">"plugin-type"</span>] &amp;&amp; (!pluginType || tiddler.fields[<span class="hljs-string">"plugin-type"</span>] === pluginType)) {
                    <span class="hljs-keyword">var</span> disablingTiddler = self.getTiddler(<span class="hljs-string">"$:/config/Plugins/Disabled/"</span> + title);
                    <span class="hljs-keyword">if</span>(title === <span class="hljs-string">"$:/core"</span> || !disablingTiddler || (disablingTiddler.fields.text || <span class="hljs-string">""</span>).trim() !== <span class="hljs-string">"yes"</span>) {
                        self.unregisterPluginTiddlers(<span class="hljs-literal">null</span>,[title]); <span class="hljs-comment">// Unregister the plugin if it's already registered</span>
                        pluginTiddlers.push(tiddler);
                        registeredTitles.push(tiddler.fields.title);
                    }
                }
            };
        <span class="hljs-keyword">if</span>(titles) {
            $tw.utils.each(titles,<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">title</span>) </span>{
                checkTiddler(self.getTiddler(title),title);
            });
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">this</span>.each(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">tiddler,title</span>) </span>{
                checkTiddler(tiddler,title);
            });
        }
        <span class="hljs-keyword">return</span> registeredTitles;
    };

    <span class="hljs-comment">// Unregister the plugin tiddlers of a particular type, or null/undefined for any type, optionally restricting unregistering to an array of tiddler titles. Returns an array of the titles affected</span>
    <span class="hljs-keyword">this</span>.unregisterPluginTiddlers = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">pluginType,titles</span>) </span>{
        <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>,
            unregisteredTitles = [];
        <span class="hljs-comment">// Remove any previous registered plugins of this type</span>
        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> t=pluginTiddlers.length<span class="hljs-number">-1</span>; t&gt;=<span class="hljs-number">0</span>; t--) {
            <span class="hljs-keyword">var</span> tiddler = pluginTiddlers[t];
            <span class="hljs-keyword">if</span>(tiddler.fields[<span class="hljs-string">"plugin-type"</span>] &amp;&amp; (!pluginType || tiddler.fields[<span class="hljs-string">"plugin-type"</span>] === pluginType) &amp;&amp; (!titles || titles.indexOf(tiddler.fields.title) !== <span class="hljs-number">-1</span>)) {
                unregisteredTitles.push(tiddler.fields.title);
                pluginTiddlers.splice(t,<span class="hljs-number">1</span>);
            }
        }
        <span class="hljs-keyword">return</span> unregisteredTitles;
    };

    <span class="hljs-comment">// Unpack the currently registered plugins, creating shadow tiddlers for their constituent tiddlers</span>
    <span class="hljs-keyword">this</span>.unpackPluginTiddlers = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;
        <span class="hljs-comment">// Sort the plugin titles by the `plugin-priority` field</span>
        pluginTiddlers.sort(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">a,b</span>) </span>{
            <span class="hljs-keyword">if</span>(<span class="hljs-string">"plugin-priority"</span> <span class="hljs-keyword">in</span> a.fields &amp;&amp; <span class="hljs-string">"plugin-priority"</span> <span class="hljs-keyword">in</span> b.fields) {
                <span class="hljs-keyword">return</span> a.fields[<span class="hljs-string">"plugin-priority"</span>] - b.fields[<span class="hljs-string">"plugin-priority"</span>];
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-string">"plugin-priority"</span> <span class="hljs-keyword">in</span> a.fields) {
                <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-string">"plugin-priority"</span> <span class="hljs-keyword">in</span> b.fields) {
                <span class="hljs-keyword">return</span> +<span class="hljs-number">1</span>;
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(a.fields.title &lt; b.fields.title) {
                <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(a.fields.title === b.fields.title) {
                <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">return</span> +<span class="hljs-number">1</span>;
            }
        });
        <span class="hljs-comment">// Now go through the plugins in ascending order and assign the shadows</span>
        shadowTiddlers = <span class="hljs-built_in">Object</span>.create(<span class="hljs-literal">null</span>);
        $tw.utils.each(pluginTiddlers,<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">tiddler</span>) </span>{
            <span class="hljs-comment">// Extract the constituent tiddlers</span>
            <span class="hljs-keyword">if</span>($tw.utils.hop(pluginInfo,tiddler.fields.title)) {
                $tw.utils.each(pluginInfo[tiddler.fields.title].tiddlers,<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">constituentTiddler,constituentTitle</span>) </span>{
                    <span class="hljs-comment">// Save the tiddler object</span>
                    <span class="hljs-keyword">if</span>(constituentTitle) {
                        shadowTiddlers[constituentTitle] = {
                            <span class="hljs-attr">source</span>: tiddler.fields.title,
                            <span class="hljs-attr">tiddler</span>: <span class="hljs-keyword">new</span> $tw.Tiddler(constituentTiddler,{<span class="hljs-attr">title</span>: constituentTitle})
                        };
                    }
                });
            }
        });
        shadowTiddlerTitles = <span class="hljs-literal">null</span>;
        <span class="hljs-keyword">this</span>.clearCache(<span class="hljs-literal">null</span>);
        <span class="hljs-keyword">this</span>.clearGlobalCache();
        $tw.utils.each(indexers,<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">indexer</span>) </span>{
            indexer.rebuild();
        });
    };

    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.addIndexersToWiki) {
        <span class="hljs-keyword">this</span>.addIndexersToWiki();
    }
};

<span class="hljs-comment">// Dummy methods that will be filled in after boot</span>
$tw.Wiki.prototype.clearCache =
$tw.Wiki.prototype.clearGlobalCache =
$tw.Wiki.prototype.enqueueTiddlerEvent = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{};

<span class="hljs-comment">// Add an array of tiddlers</span>
$tw.Wiki.prototype.addTiddlers = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">tiddlers</span>) </span>{
    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> t=<span class="hljs-number">0</span>; t&lt;tiddlers.length; t++) {
        <span class="hljs-keyword">this</span>.addTiddler(tiddlers[t]);
    }
};

<span class="hljs-comment">/*
Define all modules stored in ordinary tiddlers
*/</span>
$tw.Wiki.prototype.defineTiddlerModules = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">this</span>.each(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">tiddler,title</span>) </span>{
        <span class="hljs-keyword">if</span>(tiddler.hasField(<span class="hljs-string">"module-type"</span>)) {
            <span class="hljs-keyword">switch</span> (tiddler.fields.type) {
                <span class="hljs-keyword">case</span> <span class="hljs-string">"application/javascript"</span>:
                    <span class="hljs-comment">// We only define modules that haven't already been defined, because in the browser modules in system tiddlers are defined in inline script</span>
                    <span class="hljs-keyword">if</span>(!$tw.utils.hop($tw.modules.titles,tiddler.fields.title)) {
                        $tw.modules.define(tiddler.fields.title,tiddler.fields[<span class="hljs-string">"module-type"</span>],tiddler.fields.text);
                    }
                    <span class="hljs-keyword">break</span>;
                <span class="hljs-keyword">case</span> <span class="hljs-string">"application/json"</span>:
                    $tw.modules.define(tiddler.fields.title,tiddler.fields[<span class="hljs-string">"module-type"</span>],<span class="hljs-built_in">JSON</span>.parse(tiddler.fields.text));
                    <span class="hljs-keyword">break</span>;
                <span class="hljs-keyword">case</span> <span class="hljs-string">"application/x-tiddler-dictionary"</span>:
                    $tw.modules.define(tiddler.fields.title,tiddler.fields[<span class="hljs-string">"module-type"</span>],$tw.utils.parseFields(tiddler.fields.text));
                    <span class="hljs-keyword">break</span>;
            }
        }
    });
};

<span class="hljs-comment">/*
Register all the module tiddlers that have a module type
*/</span>
$tw.Wiki.prototype.defineShadowModules = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;
    <span class="hljs-keyword">this</span>.eachShadow(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">tiddler,title</span>) </span>{
        <span class="hljs-comment">// Don't define the module if it is overidden by an ordinary tiddler</span>
        <span class="hljs-keyword">if</span>(!self.tiddlerExists(title) &amp;&amp; tiddler.hasField(<span class="hljs-string">"module-type"</span>)) {
            <span class="hljs-comment">// Define the module</span>
            $tw.modules.define(tiddler.fields.title,tiddler.fields[<span class="hljs-string">"module-type"</span>],tiddler.fields.text);
        }
    });
};

<span class="hljs-comment">/*
Enable safe mode by deleting any tiddlers that override a shadow tiddler
*/</span>
$tw.Wiki.prototype.processSafeMode = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>,
        overrides = [];
    <span class="hljs-comment">// Find the overriding tiddlers</span>
    <span class="hljs-keyword">this</span>.each(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">tiddler,title</span>) </span>{
        <span class="hljs-keyword">if</span>(self.isShadowTiddler(title)) {
            <span class="hljs-built_in">console</span>.log(title);
            overrides.push(title);
        }
    });
    <span class="hljs-comment">// Assemble a report tiddler</span>
    <span class="hljs-keyword">var</span> titleReportTiddler = <span class="hljs-string">"TiddlyWiki Safe Mode"</span>,
        report = [];
    report.push(<span class="hljs-string">"TiddlyWiki has been started in [[safe mode|https://tiddlywiki.com/static/SafeMode.html]]. All plugins are temporarily disabled. Most customisations have been disabled by renaming the following tiddlers:"</span>)
    <span class="hljs-comment">// Delete the overrides</span>
    overrides.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">title</span>) </span>{
        <span class="hljs-keyword">var</span> tiddler = self.getTiddler(title),
            newTitle = <span class="hljs-string">"SAFE: "</span> + title;
        self.deleteTiddler(title);
        self.addTiddler(<span class="hljs-keyword">new</span> $tw.Tiddler(tiddler, {<span class="hljs-attr">title</span>: newTitle}));
        report.push(<span class="hljs-string">"* [["</span> + title + <span class="hljs-string">"|"</span> + newTitle + <span class="hljs-string">"]]"</span>);
    });
    report.push()
    <span class="hljs-keyword">this</span>.addTiddler(<span class="hljs-keyword">new</span> $tw.Tiddler({<span class="hljs-attr">title</span>: titleReportTiddler, <span class="hljs-attr">text</span>: report.join(<span class="hljs-string">"\n\n"</span>)}));
    <span class="hljs-comment">// Set $:/DefaultTiddlers to point to our report</span>
    <span class="hljs-keyword">this</span>.addTiddler(<span class="hljs-keyword">new</span> $tw.Tiddler({<span class="hljs-attr">title</span>: <span class="hljs-string">"$:/DefaultTiddlers"</span>, <span class="hljs-attr">text</span>: <span class="hljs-string">"[["</span> + titleReportTiddler + <span class="hljs-string">"]]"</span>}));
};

<span class="hljs-comment">/*
Extracts tiddlers from a typed block of text, specifying default field values
*/</span>
$tw.Wiki.prototype.deserializeTiddlers = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">type,text,srcFields,options</span>) </span>{
    srcFields = srcFields || <span class="hljs-built_in">Object</span>.create(<span class="hljs-literal">null</span>);
    options = options || {};
    <span class="hljs-keyword">var</span> deserializer = $tw.Wiki.tiddlerDeserializerModules[options.deserializer],
        fields = <span class="hljs-built_in">Object</span>.create(<span class="hljs-literal">null</span>);
    <span class="hljs-keyword">if</span>(!deserializer) {
        deserializer = $tw.Wiki.tiddlerDeserializerModules[type];
    }
    <span class="hljs-keyword">if</span>(!deserializer &amp;&amp; $tw.utils.getFileExtensionInfo(type)) {
        <span class="hljs-comment">// If we didn't find the serializer, try converting it from an extension to a content type</span>
        type = $tw.utils.getFileExtensionInfo(type).type;
        deserializer = $tw.Wiki.tiddlerDeserializerModules[type];
    }
    <span class="hljs-keyword">if</span>(!deserializer &amp;&amp; $tw.config.contentTypeInfo[type]) {
        <span class="hljs-comment">// see if this type has a different deserializer registered with it</span>
        type = $tw.config.contentTypeInfo[type].deserializerType;
        deserializer = $tw.Wiki.tiddlerDeserializerModules[type];
    }
    <span class="hljs-keyword">if</span>(!deserializer) {
        <span class="hljs-comment">// If we still don't have a deserializer, treat it as plain text</span>
        deserializer = $tw.Wiki.tiddlerDeserializerModules[<span class="hljs-string">"text/plain"</span>];
    }
    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> f <span class="hljs-keyword">in</span> srcFields) {
        fields[f] = srcFields[f];
    }
    <span class="hljs-keyword">if</span>(deserializer) {
        <span class="hljs-keyword">return</span> deserializer.call(<span class="hljs-keyword">this</span>,text,fields,type);
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// Return a raw tiddler for unknown types</span>
        fields.text = text;
        <span class="hljs-keyword">return</span> [fields];
    }
};

<span class="hljs-comment">/*
Register the built in tiddler deserializer modules
*/</span>
<span class="hljs-keyword">var</span> deserializeHeaderComment = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">text,fields</span>) </span>{
        <span class="hljs-keyword">var</span> headerCommentRegExp = <span class="hljs-keyword">new</span> <span class="hljs-built_in">RegExp</span>($tw.config.jsModuleHeaderRegExpString,<span class="hljs-string">"mg"</span>),
            match = headerCommentRegExp.exec(text);
        fields.text = text;
        <span class="hljs-keyword">if</span>(match) {
            fields = $tw.utils.parseFields(match[<span class="hljs-number">1</span>].split(<span class="hljs-regexp">/\r?\n\r?\n/mg</span>)[<span class="hljs-number">0</span>],fields);
        }
        <span class="hljs-keyword">return</span> [fields];
    };
$tw.modules.define(<span class="hljs-string">"$:/boot/tiddlerdeserializer/js"</span>,<span class="hljs-string">"tiddlerdeserializer"</span>,{
    <span class="hljs-string">"application/javascript"</span>: deserializeHeaderComment
});
$tw.modules.define(<span class="hljs-string">"$:/boot/tiddlerdeserializer/css"</span>,<span class="hljs-string">"tiddlerdeserializer"</span>,{
    <span class="hljs-string">"text/css"</span>: deserializeHeaderComment
});
$tw.modules.define(<span class="hljs-string">"$:/boot/tiddlerdeserializer/tid"</span>,<span class="hljs-string">"tiddlerdeserializer"</span>,{
    <span class="hljs-string">"application/x-tiddler"</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">text,fields</span>) </span>{
        <span class="hljs-keyword">var</span> split = text.split(<span class="hljs-regexp">/\r?\n\r?\n/mg</span>);
        <span class="hljs-keyword">if</span>(split.length &gt;= <span class="hljs-number">1</span>) {
            fields = $tw.utils.parseFields(split[<span class="hljs-number">0</span>],fields);
        }
        <span class="hljs-keyword">if</span>(split.length &gt;= <span class="hljs-number">2</span>) {
            fields.text = split.slice(<span class="hljs-number">1</span>).join(<span class="hljs-string">"\n\n"</span>);
        }
        <span class="hljs-keyword">return</span> [fields];
    }
});
$tw.modules.define(<span class="hljs-string">"$:/boot/tiddlerdeserializer/tids"</span>,<span class="hljs-string">"tiddlerdeserializer"</span>,{
    <span class="hljs-string">"application/x-tiddlers"</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">text,fields</span>) </span>{
        <span class="hljs-keyword">var</span> titles = [],
            tiddlers = [],
            match = <span class="hljs-regexp">/\r?\n\r?\n/mg</span>.exec(text);
        <span class="hljs-keyword">if</span>(match) {
            fields = $tw.utils.parseFields(text.substr(<span class="hljs-number">0</span>,match.index),fields);
            <span class="hljs-keyword">var</span> lines = text.substr(match.index + match[<span class="hljs-number">0</span>].length).split(<span class="hljs-regexp">/\r?\n/mg</span>);
            <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> t=<span class="hljs-number">0</span>; t&lt;lines.length; t++) {
                <span class="hljs-keyword">var</span> line = lines[t];
                <span class="hljs-keyword">if</span>(line.charAt(<span class="hljs-number">0</span>) !== <span class="hljs-string">"#"</span>) {
                    <span class="hljs-keyword">var</span> colonPos= line.indexOf(<span class="hljs-string">":"</span>);
                    <span class="hljs-keyword">if</span>(colonPos !== <span class="hljs-number">-1</span>) {
                        <span class="hljs-keyword">var</span> tiddler = $tw.utils.extend(<span class="hljs-built_in">Object</span>.create(<span class="hljs-literal">null</span>),fields);
                        tiddler.title = (tiddler.title || <span class="hljs-string">""</span>) + line.substr(<span class="hljs-number">0</span>,colonPos).trim();
                        <span class="hljs-keyword">if</span>(titles.indexOf(tiddler.title) !== <span class="hljs-number">-1</span>) {
                            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Warning: .multids file contains multiple definitions for "</span> + tiddler.title);
                        }
                        titles.push(tiddler.title);
                        tiddler.text = line.substr(colonPos + <span class="hljs-number">2</span>).trim();
                        tiddlers.push(tiddler);
                    }
                }
            }
        }
        <span class="hljs-keyword">return</span> tiddlers;
    }
});
$tw.modules.define(<span class="hljs-string">"$:/boot/tiddlerdeserializer/txt"</span>,<span class="hljs-string">"tiddlerdeserializer"</span>,{
    <span class="hljs-string">"text/plain"</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">text,fields,type</span>) </span>{
        fields.text = text;
        fields.type = type || <span class="hljs-string">"text/plain"</span>;
        <span class="hljs-keyword">return</span> [fields];
    }
});
$tw.modules.define(<span class="hljs-string">"$:/boot/tiddlerdeserializer/html"</span>,<span class="hljs-string">"tiddlerdeserializer"</span>,{
    <span class="hljs-string">"text/html"</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">text,fields</span>) </span>{
        fields.text = text;
        fields.type = <span class="hljs-string">"text/html"</span>;
        <span class="hljs-keyword">return</span> [fields];
    }
});
$tw.modules.define(<span class="hljs-string">"$:/boot/tiddlerdeserializer/json"</span>,<span class="hljs-string">"tiddlerdeserializer"</span>,{
    <span class="hljs-string">"application/json"</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">text,fields</span>) </span>{
        <span class="hljs-keyword">var</span> isTiddlerValid = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">data</span>) </span>{
                <span class="hljs-comment">// Not valid if it's not an object with a title property</span>
                <span class="hljs-keyword">if</span>(<span class="hljs-keyword">typeof</span>(data) !== <span class="hljs-string">"object"</span> || !$tw.utils.hop(data,<span class="hljs-string">"title"</span>)) {
                    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
                }
                <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> f <span class="hljs-keyword">in</span> data) {
                    <span class="hljs-keyword">if</span>($tw.utils.hop(data,f)) {
                        <span class="hljs-comment">// Check field name doesn't contain control characters</span>
                        <span class="hljs-keyword">if</span>(<span class="hljs-keyword">typeof</span>(data[f]) !== <span class="hljs-string">"string"</span> || <span class="hljs-regexp">/[\x00-\x1F]/</span>.test(f)) {
                            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
                        }
                    }
                }
                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
            },
            isTiddlerArrayValid = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">data</span>) </span>{
                <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> t=<span class="hljs-number">0</span>; t&lt;data.length; t++) {
                    <span class="hljs-keyword">if</span>(!isTiddlerValid(data[t])) {
                        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
                    }
                }
                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
            },
            data = {};
        <span class="hljs-keyword">try</span> {
            data = <span class="hljs-built_in">JSON</span>.parse(text);			
        } <span class="hljs-keyword">catch</span>(e) {
            <span class="hljs-comment">// Ignore JSON parse errors</span>
        }
        <span class="hljs-keyword">if</span>($tw.utils.isArray(data) &amp;&amp; isTiddlerArrayValid(data)) {
            <span class="hljs-keyword">return</span> data;
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(isTiddlerValid(data)) {
            <span class="hljs-keyword">return</span> [data];
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// Plain JSON file</span>
            fields.text = text;
            fields.type = <span class="hljs-string">"application/json"</span>;
            <span class="hljs-keyword">return</span> [fields];
        }
    }
});

<span class="hljs-comment">/////////////////////////// Browser definitions</span>

<span class="hljs-keyword">if</span>($tw.browser &amp;&amp; !$tw.node) {

<span class="hljs-comment">/*
Decrypt any tiddlers stored within the element with the ID "encryptedArea". The function is asynchronous to allow the user to be prompted for a password
    callback: function to be called the decryption is complete
*/</span>
$tw.boot.decryptEncryptedTiddlers = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">callback</span>) </span>{
    <span class="hljs-keyword">var</span> encryptedArea = <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">"encryptedStoreArea"</span>);
    <span class="hljs-keyword">if</span>(encryptedArea) {
        <span class="hljs-keyword">var</span> encryptedText = encryptedArea.innerHTML,
            prompt = <span class="hljs-string">"Enter a password to decrypt this TiddlyWiki"</span>;
        <span class="hljs-comment">// Prompt for the password</span>
        <span class="hljs-keyword">if</span>($tw.utils.hop($tw.boot,<span class="hljs-string">"encryptionPrompts"</span>)) {
            prompt = $tw.boot.encryptionPrompts.decrypt;
        }
        $tw.passwordPrompt.createPrompt({
            <span class="hljs-attr">serviceName</span>: prompt,
            <span class="hljs-attr">noUserName</span>: <span class="hljs-literal">true</span>,
            <span class="hljs-attr">submitText</span>: <span class="hljs-string">"Decrypt"</span>,
            <span class="hljs-attr">callback</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">data</span>) </span>{
                <span class="hljs-comment">// Attempt to decrypt the tiddlers</span>
                $tw.crypto.setPassword(data.password);
                <span class="hljs-keyword">var</span> decryptedText = $tw.crypto.decrypt(encryptedText);
                <span class="hljs-keyword">if</span>(decryptedText) {
                    <span class="hljs-keyword">var</span> json = <span class="hljs-built_in">JSON</span>.parse(decryptedText);
                    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> title <span class="hljs-keyword">in</span> json) {
                        $tw.preloadTiddler(json[title]);
                    }
                    <span class="hljs-comment">// Call the callback</span>
                    callback();
                    <span class="hljs-comment">// Exit and remove the password prompt</span>
                    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
                } <span class="hljs-keyword">else</span> {
                    <span class="hljs-comment">// We didn't decrypt everything, so continue to prompt for password</span>
                    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
                }
            }
        });
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// Just invoke the callback straight away if there weren't any encrypted tiddlers</span>
        callback();
    }
};

<span class="hljs-comment">/*
Register a deserializer that can extract tiddlers from the DOM
*/</span>
$tw.modules.define(<span class="hljs-string">"$:/boot/tiddlerdeserializer/dom"</span>,<span class="hljs-string">"tiddlerdeserializer"</span>,{
    <span class="hljs-string">"(DOM)"</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">node</span>) </span>{
        <span class="hljs-keyword">var</span> extractTextTiddlers = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">node</span>) </span>{
                <span class="hljs-keyword">var</span> e = node.firstChild;
                <span class="hljs-keyword">while</span>(e &amp;&amp; e.nodeName.toLowerCase() !== <span class="hljs-string">"pre"</span>) {
                    e = e.nextSibling;
                }
                <span class="hljs-keyword">var</span> title = node.getAttribute ? node.getAttribute(<span class="hljs-string">"title"</span>) : <span class="hljs-literal">null</span>;
                <span class="hljs-keyword">if</span>(e &amp;&amp; title) {
                    <span class="hljs-keyword">var</span> attrs = node.attributes,
                        tiddler = {
                            <span class="hljs-attr">text</span>: $tw.utils.htmlDecode(e.innerHTML)
                        };
                    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i=attrs.length<span class="hljs-number">-1</span>; i &gt;= <span class="hljs-number">0</span>; i--) {
                        tiddler[attrs[i].name] = attrs[i].value;
                    }
                    <span class="hljs-keyword">return</span> [tiddler];
                } <span class="hljs-keyword">else</span> {
                    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
                }
            },
            extractModuleTiddlers = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">node</span>) </span>{
                <span class="hljs-keyword">if</span>(node.hasAttribute &amp;&amp; node.hasAttribute(<span class="hljs-string">"data-tiddler-title"</span>)) {
                    <span class="hljs-keyword">var</span> text = node.innerHTML,
                        s = text.indexOf(<span class="hljs-string">"{"</span>),
                        e = text.lastIndexOf(<span class="hljs-string">"}"</span>);
                    <span class="hljs-keyword">if</span>(node.hasAttribute(<span class="hljs-string">"data-module"</span>) &amp;&amp; s !== <span class="hljs-number">-1</span> &amp;&amp; e !== <span class="hljs-number">-1</span>) {
                        text = text.substring(s+<span class="hljs-number">1</span>,e);
                    }
                    <span class="hljs-keyword">var</span> fields = {<span class="hljs-attr">text</span>: text},
                        attributes = node.attributes;
                    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> a=<span class="hljs-number">0</span>; a&lt;attributes.length; a++) {
                        <span class="hljs-keyword">if</span>(attributes[a].nodeName.substr(<span class="hljs-number">0</span>,<span class="hljs-number">13</span>) === <span class="hljs-string">"data-tiddler-"</span>) {
                            fields[attributes[a].nodeName.substr(<span class="hljs-number">13</span>)] = attributes[a].value;
                        }
                    }
                    <span class="hljs-keyword">return</span> [fields];
                } <span class="hljs-keyword">else</span> {
                    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
                }
            },
            t,result = [];
        <span class="hljs-keyword">if</span>(node) {
            <span class="hljs-keyword">var</span> type = (node.getAttribute &amp;&amp; node.getAttribute(<span class="hljs-string">"type"</span>)) || <span class="hljs-literal">null</span>;
            <span class="hljs-keyword">if</span>(type) {
                <span class="hljs-comment">// A new-style container with an explicit deserialization type</span>
                result = $tw.wiki.deserializeTiddlers(type,node.textContent);
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-comment">// An old-style container of classic DIV-based tiddlers</span>
                <span class="hljs-keyword">for</span>(t = <span class="hljs-number">0</span>; t &lt; node.childNodes.length; t++) {
                    <span class="hljs-keyword">var</span> childNode = node.childNodes[t],
                        tiddlers = extractTextTiddlers(childNode);
                    tiddlers = tiddlers || extractModuleTiddlers(childNode);
                    <span class="hljs-keyword">if</span>(tiddlers) {
                        result.push.apply(result,tiddlers);
                    }
                }
            }
        }
        <span class="hljs-keyword">return</span> result;
    }
});

$tw.loadTiddlersBrowser = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-comment">// In the browser, we load tiddlers from certain elements</span>
    <span class="hljs-keyword">var</span> containerSelectors = [
        <span class="hljs-comment">// IDs for old-style v5.1.x tiddler stores</span>
        <span class="hljs-string">"#libraryModules"</span>,
        <span class="hljs-string">"#modules"</span>,
        <span class="hljs-string">"#bootKernelPrefix"</span>,
        <span class="hljs-string">"#bootKernel"</span>,
        <span class="hljs-string">"#styleArea"</span>,
        <span class="hljs-string">"#storeArea"</span>,
        <span class="hljs-string">"#systemArea"</span>,
        <span class="hljs-comment">// Classes for new-style v5.2.x JSON tiddler stores</span>
        <span class="hljs-string">"script.tiddlywiki-tiddler-store"</span>
    ];
    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> t=<span class="hljs-number">0</span>; t&lt;containerSelectors.length; t++) {
        <span class="hljs-keyword">var</span> nodes = <span class="hljs-built_in">document</span>.querySelectorAll(containerSelectors[t]);
        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> n=<span class="hljs-number">0</span>; n&lt;nodes.length; n++) {
            $tw.wiki.addTiddlers($tw.wiki.deserializeTiddlers(<span class="hljs-string">"(DOM)"</span>,nodes[n]));
        }
    }
};

} <span class="hljs-keyword">else</span> {

<span class="hljs-comment">/////////////////////////// Server definitions</span>

<span class="hljs-comment">/*
Get any encrypted tiddlers
*/</span>
$tw.boot.decryptEncryptedTiddlers = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">callback</span>) </span>{
    <span class="hljs-comment">// Storing encrypted tiddlers on the server isn't supported yet</span>
    callback();
};

} <span class="hljs-comment">// End of if($tw.browser &amp;&amp; !$tw.node)</span>

<span class="hljs-comment">/////////////////////////// Node definitions</span>

<span class="hljs-keyword">if</span>($tw.node) {

<span class="hljs-comment">/*
Load the tiddlers contained in a particular file (and optionally extract fields from the accompanying .meta file) returned as {filepath:,type:,tiddlers:[],hasMetaFile:}
*/</span>
$tw.loadTiddlersFromFile = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">filepath,fields</span>) </span>{
    <span class="hljs-keyword">var</span> ext = path.extname(filepath),
        extensionInfo = $tw.utils.getFileExtensionInfo(ext),
        type = extensionInfo ? extensionInfo.type : <span class="hljs-literal">null</span>,
        typeInfo = type ? $tw.config.contentTypeInfo[type] : <span class="hljs-literal">null</span>,
        data = fs.readFileSync(filepath,typeInfo ? typeInfo.encoding : <span class="hljs-string">"utf8"</span>),
        tiddlers = $tw.wiki.deserializeTiddlers(ext,data,fields),
        metadata = $tw.loadMetadataForFile(filepath);
    <span class="hljs-keyword">if</span>(metadata) {
        <span class="hljs-keyword">if</span>(type === <span class="hljs-string">"application/json"</span>) {
            tiddlers = [{<span class="hljs-attr">text</span>: data, <span class="hljs-attr">type</span>: <span class="hljs-string">"application/json"</span>}];
        }
        tiddlers = [$tw.utils.extend({},tiddlers[<span class="hljs-number">0</span>],metadata)];
    }
    <span class="hljs-keyword">return</span> {<span class="hljs-attr">filepath</span>: filepath, <span class="hljs-attr">type</span>: type, <span class="hljs-attr">tiddlers</span>: tiddlers, <span class="hljs-attr">hasMetaFile</span>: !!metadata};
};

<span class="hljs-comment">/*
Load the metadata fields in the .meta file corresponding to a particular file
*/</span>
$tw.loadMetadataForFile = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">filepath</span>) </span>{
    <span class="hljs-keyword">var</span> metafilename = filepath + <span class="hljs-string">".meta"</span>;
    <span class="hljs-keyword">if</span>(fs.existsSync(metafilename)) {
        <span class="hljs-keyword">return</span> $tw.utils.parseFields(fs.readFileSync(metafilename,<span class="hljs-string">"utf8"</span>) || <span class="hljs-string">""</span>);
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    }
};

<span class="hljs-comment">/*
A default set of files for TiddlyWiki to ignore during load.
This matches what NPM ignores, and adds "*.meta" to ignore tiddler
metadata files.
*/</span>
$tw.boot.excludeRegExp = <span class="hljs-regexp">/^\.DS_Store$|^.*\.meta$|^\..*\.swp$|^\._.*$|^\.git$|^\.hg$|^\.lock-wscript$|^\.svn$|^\.wafpickle-.*$|^CVS$|^npm-debug\.log$/</span>;

<span class="hljs-comment">/*
Load all the tiddlers recursively from a directory, including honouring `tiddlywiki.files` files for drawing in external files. Returns an array of {filepath:,type:,tiddlers: [{..fields...}],hasMetaFile:}. Note that no file information is returned for externally loaded tiddlers, just the `tiddlers` property.
*/</span>
$tw.loadTiddlersFromPath = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">filepath,excludeRegExp</span>) </span>{
    excludeRegExp = excludeRegExp || $tw.boot.excludeRegExp;
    <span class="hljs-keyword">var</span> tiddlers = [];
    <span class="hljs-keyword">if</span>(fs.existsSync(filepath)) {
        <span class="hljs-keyword">var</span> stat = fs.statSync(filepath);
        <span class="hljs-keyword">if</span>(stat.isDirectory()) {
            <span class="hljs-keyword">var</span> files = fs.readdirSync(filepath);
            <span class="hljs-comment">// Look for a tiddlywiki.files file</span>
            <span class="hljs-keyword">if</span>(files.indexOf(<span class="hljs-string">"tiddlywiki.files"</span>) !== <span class="hljs-number">-1</span>) {
                <span class="hljs-built_in">Array</span>.prototype.push.apply(tiddlers,$tw.loadTiddlersFromSpecification(filepath,excludeRegExp));
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-comment">// If not, read all the files in the directory</span>
                $tw.utils.each(files,<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">file</span>) </span>{
                    <span class="hljs-keyword">if</span>(!excludeRegExp.test(file) &amp;&amp; file !== <span class="hljs-string">"plugin.info"</span>) {
                        tiddlers.push.apply(tiddlers,$tw.loadTiddlersFromPath(filepath + path.sep + file,excludeRegExp));
                    }
                });
            }
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(stat.isFile()) {
            tiddlers.push($tw.loadTiddlersFromFile(filepath,{<span class="hljs-attr">title</span>: filepath}));
        }
    }
    <span class="hljs-keyword">return</span> tiddlers;
};

<span class="hljs-comment">/*
Load all the tiddlers defined by a `tiddlywiki.files` specification file
filepath: pathname of the directory containing the specification file
*/</span>
$tw.loadTiddlersFromSpecification = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">filepath,excludeRegExp</span>) </span>{
    <span class="hljs-keyword">var</span> tiddlers = [];
    <span class="hljs-comment">// Read the specification</span>
    <span class="hljs-keyword">var</span> filesInfo = <span class="hljs-built_in">JSON</span>.parse(fs.readFileSync(filepath + path.sep + <span class="hljs-string">"tiddlywiki.files"</span>,<span class="hljs-string">"utf8"</span>));
    <span class="hljs-comment">// Helper to process a file</span>
    <span class="hljs-keyword">var</span> processFile = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">filename,isTiddlerFile,fields,isEditableFile</span>) </span>{
        <span class="hljs-keyword">var</span> extInfo = $tw.config.fileExtensionInfo[path.extname(filename)],
            type = (extInfo || {}).type || fields.type || <span class="hljs-string">"text/plain"</span>,
            typeInfo = $tw.config.contentTypeInfo[type] || {},
            pathname = path.resolve(filepath,filename),
            text = fs.readFileSync(pathname,typeInfo.encoding || <span class="hljs-string">"utf8"</span>),
            metadata = $tw.loadMetadataForFile(pathname) || {},
            fileTiddlers;
        <span class="hljs-keyword">if</span>(isTiddlerFile) {
            fileTiddlers = $tw.wiki.deserializeTiddlers(path.extname(pathname),text,metadata) || [];
        } <span class="hljs-keyword">else</span> {
            fileTiddlers =  [$tw.utils.extend({<span class="hljs-attr">text</span>: text},metadata)];
        }
        <span class="hljs-keyword">var</span> combinedFields = $tw.utils.extend({},fields,metadata);
        $tw.utils.each(fileTiddlers,<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">tiddler</span>) </span>{
            $tw.utils.each(combinedFields,<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">fieldInfo,name</span>) </span>{
                <span class="hljs-keyword">if</span>(<span class="hljs-keyword">typeof</span> fieldInfo === <span class="hljs-string">"string"</span> || $tw.utils.isArray(fieldInfo)) {
                    tiddler[name] = fieldInfo;
                } <span class="hljs-keyword">else</span> {
                    <span class="hljs-keyword">var</span> value = tiddler[name];
                    <span class="hljs-keyword">switch</span>(fieldInfo.source) {
                        <span class="hljs-keyword">case</span> <span class="hljs-string">"filename"</span>:
                            value = path.basename(filename);
                            <span class="hljs-keyword">break</span>;
                        <span class="hljs-keyword">case</span> <span class="hljs-string">"filename-uri-decoded"</span>:
                            value = $tw.utils.decodeURIComponentSafe(path.basename(filename));
                            <span class="hljs-keyword">break</span>;
                        <span class="hljs-keyword">case</span> <span class="hljs-string">"basename"</span>:
                            value = path.basename(filename,path.extname(filename));
                            <span class="hljs-keyword">break</span>;
                        <span class="hljs-keyword">case</span> <span class="hljs-string">"basename-uri-decoded"</span>:
                            value = $tw.utils.decodeURIComponentSafe(path.basename(filename,path.extname(filename)));
                            <span class="hljs-keyword">break</span>;
                        <span class="hljs-keyword">case</span> <span class="hljs-string">"extname"</span>:
                            value = path.extname(filename);
                            <span class="hljs-keyword">break</span>;
                        <span class="hljs-keyword">case</span> <span class="hljs-string">"created"</span>:
                            value = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(fs.statSync(pathname).birthtime);
                            <span class="hljs-keyword">break</span>;
                        <span class="hljs-keyword">case</span> <span class="hljs-string">"modified"</span>:
                            value = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(fs.statSync(pathname).mtime);
                            <span class="hljs-keyword">break</span>;
                    }
                    <span class="hljs-keyword">if</span>(fieldInfo.prefix) {
                        value = fieldInfo.prefix + value;
                    }
                    <span class="hljs-keyword">if</span>(fieldInfo.suffix) {
                        value = value + fieldInfo.suffix;
                    }
                    tiddler[name] = value;
                }
            });
        });
        <span class="hljs-keyword">if</span>(isEditableFile) {
            tiddlers.push({<span class="hljs-attr">filepath</span>: pathname, <span class="hljs-attr">hasMetaFile</span>: !!metadata &amp;&amp; !isTiddlerFile, <span class="hljs-attr">isEditableFile</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">tiddlers</span>: fileTiddlers});
        } <span class="hljs-keyword">else</span> {
            tiddlers.push({<span class="hljs-attr">tiddlers</span>: fileTiddlers});
        }
    };
    <span class="hljs-comment">// Process the listed tiddlers</span>
    $tw.utils.each(filesInfo.tiddlers,<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">tidInfo</span>) </span>{
        <span class="hljs-keyword">if</span>(tidInfo.prefix &amp;&amp; tidInfo.suffix) {
            tidInfo.fields.text = {<span class="hljs-attr">prefix</span>: tidInfo.prefix,<span class="hljs-attr">suffix</span>: tidInfo.suffix};
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(tidInfo.prefix) {
            tidInfo.fields.text = {<span class="hljs-attr">prefix</span>: tidInfo.prefix};
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(tidInfo.suffix) {
            tidInfo.fields.text = {<span class="hljs-attr">suffix</span>: tidInfo.suffix};
        }
        processFile(tidInfo.file,tidInfo.isTiddlerFile,tidInfo.fields);
    });
    <span class="hljs-comment">// Process any listed directories</span>
    $tw.utils.each(filesInfo.directories,<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">dirSpec</span>) </span>{
        <span class="hljs-comment">// Read literal directories directly</span>
        <span class="hljs-keyword">if</span>(<span class="hljs-keyword">typeof</span> dirSpec === <span class="hljs-string">"string"</span>) {
            <span class="hljs-keyword">var</span> pathname = path.resolve(filepath,dirSpec);
            <span class="hljs-keyword">if</span>(fs.existsSync(pathname) &amp;&amp; fs.statSync(pathname).isDirectory()) {
                tiddlers.push.apply(tiddlers,$tw.loadTiddlersFromPath(pathname,excludeRegExp));
            }
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// Process directory specifier</span>
            <span class="hljs-keyword">var</span> dirPath = path.resolve(filepath,dirSpec.path);
            <span class="hljs-keyword">if</span>(fs.existsSync(dirPath) &amp;&amp; fs.statSync(dirPath).isDirectory()) {
                <span class="hljs-keyword">var</span>	files = fs.readdirSync(dirPath),
                    fileRegExp = <span class="hljs-keyword">new</span> <span class="hljs-built_in">RegExp</span>(dirSpec.filesRegExp || <span class="hljs-string">"^.*$"</span>),
                    metaRegExp = <span class="hljs-regexp">/^.*\.meta$/</span>;
                <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> t=<span class="hljs-number">0</span>; t&lt;files.length; t++) {
                    <span class="hljs-keyword">var</span> filename = files[t];
                    <span class="hljs-keyword">if</span>(filename !== <span class="hljs-string">"tiddlywiki.files"</span> &amp;&amp; !metaRegExp.test(filename) &amp;&amp; fileRegExp.test(filename)) {
                        processFile(dirPath + path.sep + filename,dirSpec.isTiddlerFile,dirSpec.fields,dirSpec.isEditableFile);
                    }
                }
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Warning: a directory in a tiddlywiki.files file does not exist."</span>);
                <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"dirPath: "</span> + dirPath);
                <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"tiddlywiki.files location: "</span> + filepath);
            }
        }
    });
    <span class="hljs-keyword">return</span> tiddlers;
};

<span class="hljs-comment">/*
Load the tiddlers from a plugin folder, and package them up into a proper JSON plugin tiddler
*/</span>
$tw.loadPluginFolder = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">filepath,excludeRegExp</span>) </span>{
    excludeRegExp = excludeRegExp || $tw.boot.excludeRegExp;
    <span class="hljs-keyword">var</span> infoPath = filepath + path.sep + <span class="hljs-string">"plugin.info"</span>;
    <span class="hljs-keyword">if</span>(fs.existsSync(filepath) &amp;&amp; fs.statSync(filepath).isDirectory()) {
        <span class="hljs-comment">// Read the plugin information</span>
        <span class="hljs-keyword">if</span>(!fs.existsSync(infoPath) || !fs.statSync(infoPath).isFile()) {
            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Warning: missing plugin.info file in "</span> + filepath);
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        }
        <span class="hljs-keyword">var</span> pluginInfo = <span class="hljs-built_in">JSON</span>.parse(fs.readFileSync(infoPath,<span class="hljs-string">"utf8"</span>));
        <span class="hljs-comment">// Read the plugin files</span>
        <span class="hljs-keyword">var</span> pluginFiles = $tw.loadTiddlersFromPath(filepath,excludeRegExp);
        <span class="hljs-comment">// Save the plugin tiddlers into the plugin info</span>
        pluginInfo.tiddlers = pluginInfo.tiddlers || <span class="hljs-built_in">Object</span>.create(<span class="hljs-literal">null</span>);
        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> f=<span class="hljs-number">0</span>; f&lt;pluginFiles.length; f++) {
            <span class="hljs-keyword">var</span> tiddlers = pluginFiles[f].tiddlers;
            <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> t=<span class="hljs-number">0</span>; t&lt;tiddlers.length; t++) {
                <span class="hljs-keyword">var</span> tiddler= tiddlers[t];
                <span class="hljs-keyword">if</span>(tiddler.title) {
                    pluginInfo.tiddlers[tiddler.title] = tiddler;
                }
            }
        }
        <span class="hljs-comment">// Give the plugin the same version number as the core if it doesn't have one</span>
        <span class="hljs-keyword">if</span>(!(<span class="hljs-string">"version"</span> <span class="hljs-keyword">in</span> pluginInfo)) {
            pluginInfo.version = $tw.packageInfo.version;
        }
        <span class="hljs-comment">// Use "plugin" as the plugin-type if we don't have one</span>
        <span class="hljs-keyword">if</span>(!(<span class="hljs-string">"plugin-type"</span> <span class="hljs-keyword">in</span> pluginInfo)) {
            pluginInfo[<span class="hljs-string">"plugin-type"</span>] = <span class="hljs-string">"plugin"</span>;
        }
        pluginInfo.dependents = pluginInfo.dependents || [];
        pluginInfo.type = <span class="hljs-string">"application/json"</span>;
        <span class="hljs-comment">// Set plugin text</span>
        pluginInfo.text = <span class="hljs-built_in">JSON</span>.stringify({<span class="hljs-attr">tiddlers</span>: pluginInfo.tiddlers});
        <span class="hljs-keyword">delete</span> pluginInfo.tiddlers;
        <span class="hljs-comment">// Deserialise array fields (currently required for the dependents field)</span>
        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> field <span class="hljs-keyword">in</span> pluginInfo) {
            <span class="hljs-keyword">if</span>($tw.utils.isArray(pluginInfo[field])) {
                pluginInfo[field] = $tw.utils.stringifyList(pluginInfo[field]);
            }
        }
        <span class="hljs-keyword">return</span> pluginInfo;
    } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    }
};

<span class="hljs-comment">/*
name: Name of the plugin to find
paths: array of file paths to search for it
Returns the path of the plugin folder
*/</span>
$tw.findLibraryItem = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">name,paths</span>) </span>{
    <span class="hljs-keyword">var</span> pathIndex = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">do</span> {
        <span class="hljs-keyword">var</span> pluginPath = path.resolve(paths[pathIndex],<span class="hljs-string">"./"</span> + name)
        <span class="hljs-keyword">if</span>(fs.existsSync(pluginPath) &amp;&amp; fs.statSync(pluginPath).isDirectory()) {
            <span class="hljs-keyword">return</span> pluginPath;
        }
    } <span class="hljs-keyword">while</span>(++pathIndex &lt; paths.length);
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
};

<span class="hljs-comment">/*
name: Name of the plugin to load
paths: array of file paths to search for it
*/</span>
$tw.loadPlugin = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">name,paths</span>) </span>{
    <span class="hljs-keyword">var</span> pluginPath = $tw.findLibraryItem(name,paths);
    <span class="hljs-keyword">if</span>(pluginPath) {
        <span class="hljs-keyword">var</span> pluginFields = $tw.loadPluginFolder(pluginPath);
        <span class="hljs-keyword">if</span>(pluginFields) {
            $tw.wiki.addTiddler(pluginFields);
            <span class="hljs-keyword">return</span>;
        }
    }
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Warning: Cannot find plugin '"</span> + name + <span class="hljs-string">"'"</span>);
};

<span class="hljs-comment">/*
libraryPath: Path of library folder for these plugins (relative to core path)
envVar: Environment variable name for these plugins
Returns an array of search paths
*/</span>
$tw.getLibraryItemSearchPaths = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">libraryPath,envVar</span>) </span>{
    <span class="hljs-keyword">var</span> pluginPaths = [path.resolve($tw.boot.corePath,libraryPath)],
        env = process.env[envVar];
    <span class="hljs-keyword">if</span>(env) {
        env.split(path.delimiter).map(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">item</span>) </span>{
            <span class="hljs-keyword">if</span>(item) {
                pluginPaths.push(item);
            }
        });
    }
    <span class="hljs-keyword">return</span> pluginPaths;
};

<span class="hljs-comment">/*
plugins: Array of names of plugins (eg, "tiddlywiki/filesystemadaptor")
libraryPath: Path of library folder for these plugins (relative to core path)
envVar: Environment variable name for these plugins
*/</span>
$tw.loadPlugins = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">plugins,libraryPath,envVar</span>) </span>{
    <span class="hljs-keyword">if</span>(plugins) {
        <span class="hljs-keyword">var</span> pluginPaths = $tw.getLibraryItemSearchPaths(libraryPath,envVar);
        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> t=<span class="hljs-number">0</span>; t&lt;plugins.length; t++) {
            $tw.loadPlugin(plugins[t],pluginPaths);
        }
    }
};

<span class="hljs-comment">/*
path: path of wiki directory
options:
    parentPaths: array of parent paths that we mustn't recurse into
    readOnly: true if the tiddler file paths should not be retained
*/</span>
$tw.loadWikiTiddlers = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">wikiPath,options</span>) </span>{
    options = options || {};
    <span class="hljs-keyword">var</span> parentPaths = options.parentPaths || [],
        wikiInfoPath = path.resolve(wikiPath,$tw.config.wikiInfo),
        wikiInfo,
        pluginFields;
    <span class="hljs-comment">// Bail if we don't have a wiki info file</span>
    <span class="hljs-keyword">if</span>(fs.existsSync(wikiInfoPath)) {
        wikiInfo = <span class="hljs-built_in">JSON</span>.parse(fs.readFileSync(wikiInfoPath,<span class="hljs-string">"utf8"</span>));
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    }
    <span class="hljs-comment">// Save the path to the tiddlers folder for the filesystemadaptor</span>
    <span class="hljs-keyword">var</span> config = wikiInfo.config || {};
    <span class="hljs-keyword">if</span>($tw.boot.wikiPath == wikiPath) {
        $tw.boot.wikiTiddlersPath = path.resolve($tw.boot.wikiPath,config[<span class="hljs-string">"default-tiddler-location"</span>] || $tw.config.wikiTiddlersSubDir);
    }
    <span class="hljs-comment">// Load any parent wikis</span>
    <span class="hljs-keyword">if</span>(wikiInfo.includeWikis) {
        parentPaths = parentPaths.slice(<span class="hljs-number">0</span>);
        parentPaths.push(wikiPath);
        $tw.utils.each(wikiInfo.includeWikis,<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">info</span>) </span>{
            <span class="hljs-keyword">if</span>(<span class="hljs-keyword">typeof</span> info === <span class="hljs-string">"string"</span>) {
                info = {<span class="hljs-attr">path</span>: info};
            }
            <span class="hljs-keyword">var</span> resolvedIncludedWikiPath = path.resolve(wikiPath,info.path);
            <span class="hljs-keyword">if</span>(parentPaths.indexOf(resolvedIncludedWikiPath) === <span class="hljs-number">-1</span>) {
                <span class="hljs-keyword">var</span> subWikiInfo = $tw.loadWikiTiddlers(resolvedIncludedWikiPath,{
                    <span class="hljs-attr">parentPaths</span>: parentPaths,
                    <span class="hljs-attr">readOnly</span>: info[<span class="hljs-string">"read-only"</span>]
                });
                <span class="hljs-comment">// Merge the build targets</span>
                wikiInfo.build = $tw.utils.extend([],subWikiInfo.build,wikiInfo.build);
            } <span class="hljs-keyword">else</span> {
                $tw.utils.error(<span class="hljs-string">"Cannot recursively include wiki "</span> + resolvedIncludedWikiPath);
            }
        });
    }
    <span class="hljs-comment">// Load any plugins, themes and languages listed in the wiki info file</span>
    $tw.loadPlugins(wikiInfo.plugins,$tw.config.pluginsPath,$tw.config.pluginsEnvVar);
    $tw.loadPlugins(wikiInfo.themes,$tw.config.themesPath,$tw.config.themesEnvVar);
    $tw.loadPlugins(wikiInfo.languages,$tw.config.languagesPath,$tw.config.languagesEnvVar);
    <span class="hljs-comment">// Load the wiki files, registering them as writable</span>
    <span class="hljs-keyword">var</span> resolvedWikiPath = path.resolve(wikiPath,$tw.config.wikiTiddlersSubDir);
    $tw.utils.each($tw.loadTiddlersFromPath(resolvedWikiPath),<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">tiddlerFile</span>) </span>{
        <span class="hljs-keyword">if</span>(!options.readOnly &amp;&amp; tiddlerFile.filepath) {
            $tw.utils.each(tiddlerFile.tiddlers,<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">tiddler</span>) </span>{
                $tw.boot.files[tiddler.title] = {
                    <span class="hljs-attr">filepath</span>: tiddlerFile.filepath,
                    <span class="hljs-attr">type</span>: tiddlerFile.type,
                    <span class="hljs-attr">hasMetaFile</span>: tiddlerFile.hasMetaFile,
                    <span class="hljs-attr">isEditableFile</span>: config[<span class="hljs-string">"retain-original-tiddler-path"</span>] || tiddlerFile.isEditableFile || tiddlerFile.filepath.indexOf($tw.boot.wikiTiddlersPath) !== <span class="hljs-number">0</span>
                };
            });
        }
        $tw.wiki.addTiddlers(tiddlerFile.tiddlers);
    });
    <span class="hljs-keyword">if</span> ($tw.boot.wikiPath == wikiPath) {
        <span class="hljs-comment">// Save the original tiddler file locations if requested</span>
        <span class="hljs-keyword">var</span> output = {}, relativePath, fileInfo;
        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> title <span class="hljs-keyword">in</span> $tw.boot.files) {
            fileInfo = $tw.boot.files[title];
            <span class="hljs-keyword">if</span>(fileInfo.isEditableFile) {
                relativePath = path.relative($tw.boot.wikiTiddlersPath,fileInfo.filepath);
                fileInfo.originalpath = relativePath;
                output[title] =
                    path.sep === <span class="hljs-string">"/"</span> ?
                    relativePath :
                    relativePath.split(path.sep).join(<span class="hljs-string">"/"</span>);
            }
        }
        <span class="hljs-keyword">if</span>(<span class="hljs-built_in">Object</span>.keys(output).length &gt; <span class="hljs-number">0</span>){
            $tw.wiki.addTiddler({<span class="hljs-attr">title</span>: <span class="hljs-string">"$:/config/OriginalTiddlerPaths"</span>, <span class="hljs-attr">type</span>: <span class="hljs-string">"application/json"</span>, <span class="hljs-attr">text</span>: <span class="hljs-built_in">JSON</span>.stringify(output)});
        }
    }
    <span class="hljs-comment">// Load any plugins within the wiki folder</span>
    <span class="hljs-keyword">var</span> wikiPluginsPath = path.resolve(wikiPath,$tw.config.wikiPluginsSubDir);
    <span class="hljs-keyword">if</span>(fs.existsSync(wikiPluginsPath)) {
        <span class="hljs-keyword">var</span> pluginFolders = fs.readdirSync(wikiPluginsPath);
        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> t=<span class="hljs-number">0</span>; t&lt;pluginFolders.length; t++) {
            pluginFields = $tw.loadPluginFolder(path.resolve(wikiPluginsPath,<span class="hljs-string">"./"</span> + pluginFolders[t]));
            <span class="hljs-keyword">if</span>(pluginFields) {
                $tw.wiki.addTiddler(pluginFields);
            }
        }
    }
    <span class="hljs-comment">// Load any themes within the wiki folder</span>
    <span class="hljs-keyword">var</span> wikiThemesPath = path.resolve(wikiPath,$tw.config.wikiThemesSubDir);
    <span class="hljs-keyword">if</span>(fs.existsSync(wikiThemesPath)) {
        <span class="hljs-keyword">var</span> themeFolders = fs.readdirSync(wikiThemesPath);
        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> t=<span class="hljs-number">0</span>; t&lt;themeFolders.length; t++) {
            pluginFields = $tw.loadPluginFolder(path.resolve(wikiThemesPath,<span class="hljs-string">"./"</span> + themeFolders[t]));
            <span class="hljs-keyword">if</span>(pluginFields) {
                $tw.wiki.addTiddler(pluginFields);
            }
        }
    }
    <span class="hljs-comment">// Load any languages within the wiki folder</span>
    <span class="hljs-keyword">var</span> wikiLanguagesPath = path.resolve(wikiPath,$tw.config.wikiLanguagesSubDir);
    <span class="hljs-keyword">if</span>(fs.existsSync(wikiLanguagesPath)) {
        <span class="hljs-keyword">var</span> languageFolders = fs.readdirSync(wikiLanguagesPath);
        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> t=<span class="hljs-number">0</span>; t&lt;languageFolders.length; t++) {
            pluginFields = $tw.loadPluginFolder(path.resolve(wikiLanguagesPath,<span class="hljs-string">"./"</span> + languageFolders[t]));
            <span class="hljs-keyword">if</span>(pluginFields) {
                $tw.wiki.addTiddler(pluginFields);
            }
        }
    }
    <span class="hljs-keyword">return</span> wikiInfo;
};

$tw.loadTiddlersNode = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-comment">// Load the boot tiddlers</span>
    $tw.utils.each($tw.loadTiddlersFromPath($tw.boot.bootPath),<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">tiddlerFile</span>) </span>{
        $tw.wiki.addTiddlers(tiddlerFile.tiddlers);
    });
    <span class="hljs-comment">// Load the core tiddlers</span>
    $tw.wiki.addTiddler($tw.loadPluginFolder($tw.boot.corePath));
    <span class="hljs-comment">// Load any extra plugins</span>
    $tw.utils.each($tw.boot.extraPlugins,<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">name</span>) </span>{
        <span class="hljs-keyword">if</span>(name.charAt(<span class="hljs-number">0</span>) === <span class="hljs-string">"+"</span>) { <span class="hljs-comment">// Relative path to plugin</span>
            <span class="hljs-keyword">var</span> pluginFields = $tw.loadPluginFolder(name.substring(<span class="hljs-number">1</span>));
            <span class="hljs-keyword">if</span>(pluginFields) {
                $tw.wiki.addTiddler(pluginFields);
            }
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">var</span> parts = name.split(<span class="hljs-string">"/"</span>),
                type = parts[<span class="hljs-number">0</span>];
            <span class="hljs-keyword">if</span>(parts.length  === <span class="hljs-number">3</span> &amp;&amp; [<span class="hljs-string">"plugins"</span>,<span class="hljs-string">"themes"</span>,<span class="hljs-string">"languages"</span>].indexOf(type) !== <span class="hljs-number">-1</span>) {
                $tw.loadPlugins([parts[<span class="hljs-number">1</span>] + <span class="hljs-string">"/"</span> + parts[<span class="hljs-number">2</span>]],$tw.config[type + <span class="hljs-string">"Path"</span>],$tw.config[type + <span class="hljs-string">"EnvVar"</span>]);
            }
        }
    });
    <span class="hljs-comment">// Load the tiddlers from the wiki directory</span>
    <span class="hljs-keyword">if</span>($tw.boot.wikiPath) {
        $tw.boot.wikiInfo = $tw.loadWikiTiddlers($tw.boot.wikiPath);
    }
};

<span class="hljs-comment">// End of if($tw.node)</span>
}

<span class="hljs-comment">/////////////////////////// Main startup function called once tiddlers have been decrypted</span>

<span class="hljs-comment">/*
Startup TiddlyWiki
*/</span>
$tw.boot.initStartup = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">options</span>) </span>{
    <span class="hljs-comment">// Get the URL hash and check for safe mode</span>
    $tw.locationHash = <span class="hljs-string">"#"</span>;
    <span class="hljs-keyword">if</span>($tw.browser &amp;&amp; !$tw.node) {
        <span class="hljs-keyword">if</span>(location.hash === <span class="hljs-string">"#:safe"</span>) {
            $tw.safeMode = <span class="hljs-literal">true</span>;
        } <span class="hljs-keyword">else</span> {
            $tw.locationHash = $tw.utils.getLocationHash();
        }
    }
    <span class="hljs-comment">// Initialise some more $tw properties</span>
    $tw.utils.deepDefaults($tw,{
        <span class="hljs-attr">modules</span>: { <span class="hljs-comment">// Information about each module</span>
            <span class="hljs-attr">titles</span>: <span class="hljs-built_in">Object</span>.create(<span class="hljs-literal">null</span>), <span class="hljs-comment">// hashmap by module title of {fn:, exports:, moduleType:}</span>
            <span class="hljs-attr">types</span>: {} <span class="hljs-comment">// hashmap by module type of hashmap of exports</span>
        },
        <span class="hljs-attr">config</span>: { <span class="hljs-comment">// Configuration overridables</span>
            <span class="hljs-attr">pluginsPath</span>: <span class="hljs-string">"../plugins/"</span>,
            <span class="hljs-attr">themesPath</span>: <span class="hljs-string">"../themes/"</span>,
            <span class="hljs-attr">languagesPath</span>: <span class="hljs-string">"../languages/"</span>,
            <span class="hljs-attr">editionsPath</span>: <span class="hljs-string">"../editions/"</span>,
            <span class="hljs-attr">wikiInfo</span>: <span class="hljs-string">"./tiddlywiki.info"</span>,
            <span class="hljs-attr">wikiPluginsSubDir</span>: <span class="hljs-string">"./plugins"</span>,
            <span class="hljs-attr">wikiThemesSubDir</span>: <span class="hljs-string">"./themes"</span>,
            <span class="hljs-attr">wikiLanguagesSubDir</span>: <span class="hljs-string">"./languages"</span>,
            <span class="hljs-attr">wikiTiddlersSubDir</span>: <span class="hljs-string">"./tiddlers"</span>,
            <span class="hljs-attr">wikiOutputSubDir</span>: <span class="hljs-string">"./output"</span>,
            <span class="hljs-attr">jsModuleHeaderRegExpString</span>: <span class="hljs-string">"^\\/\\*\\\\(?:\\r?\\n)((?:^[^\\r\\n]*(?:\\r?\\n))+?)(^\\\\\\*\\/$(?:\\r?\\n)?)"</span>,
            <span class="hljs-attr">fileExtensionInfo</span>: <span class="hljs-built_in">Object</span>.create(<span class="hljs-literal">null</span>), <span class="hljs-comment">// Map file extension to {type:}</span>
            <span class="hljs-attr">contentTypeInfo</span>: <span class="hljs-built_in">Object</span>.create(<span class="hljs-literal">null</span>), <span class="hljs-comment">// Map type to {encoding:,extension:}</span>
            <span class="hljs-attr">pluginsEnvVar</span>: <span class="hljs-string">"TIDDLYWIKI_PLUGIN_PATH"</span>,
            <span class="hljs-attr">themesEnvVar</span>: <span class="hljs-string">"TIDDLYWIKI_THEME_PATH"</span>,
            <span class="hljs-attr">languagesEnvVar</span>: <span class="hljs-string">"TIDDLYWIKI_LANGUAGE_PATH"</span>,
            <span class="hljs-attr">editionsEnvVar</span>: <span class="hljs-string">"TIDDLYWIKI_EDITION_PATH"</span>
        },
        <span class="hljs-attr">log</span>: {}, <span class="hljs-comment">// Log flags</span>
        <span class="hljs-attr">unloadTasks</span>: []
    });
    <span class="hljs-keyword">if</span>(!$tw.boot.tasks.readBrowserTiddlers) {
        <span class="hljs-comment">// For writable tiddler files, a hashmap of title to {filepath:,type:,hasMetaFile:}</span>
        $tw.boot.files = <span class="hljs-built_in">Object</span>.create(<span class="hljs-literal">null</span>);
        <span class="hljs-comment">// System paths and filenames</span>
        $tw.boot.bootPath = options.bootPath || path.dirname(<span class="hljs-built_in">module</span>.filename);
        $tw.boot.corePath = path.resolve($tw.boot.bootPath,<span class="hljs-string">"../core"</span>);
        <span class="hljs-comment">// If there's no arguments then default to `--help`</span>
        <span class="hljs-keyword">if</span>($tw.boot.argv.length === <span class="hljs-number">0</span>) {
            $tw.boot.argv = [<span class="hljs-string">"--help"</span>];
        }
        <span class="hljs-comment">// Parse any extra plugin references</span>
        $tw.boot.extraPlugins = $tw.boot.extraPlugins || [];
        <span class="hljs-keyword">while</span>($tw.boot.argv[<span class="hljs-number">0</span>] &amp;&amp; $tw.boot.argv[<span class="hljs-number">0</span>].indexOf(<span class="hljs-string">"+"</span>) === <span class="hljs-number">0</span>) {
            $tw.boot.extraPlugins.push($tw.boot.argv[<span class="hljs-number">0</span>].substring(<span class="hljs-number">1</span>));
            $tw.boot.argv.splice(<span class="hljs-number">0</span>,<span class="hljs-number">1</span>);
        }
        <span class="hljs-comment">// If the first command line argument doesn't start with `--` then we</span>
        <span class="hljs-comment">// interpret it as the path to the wiki folder, which will otherwise default</span>
        <span class="hljs-comment">// to the current folder</span>
        <span class="hljs-keyword">if</span>($tw.boot.argv[<span class="hljs-number">0</span>] &amp;&amp; $tw.boot.argv[<span class="hljs-number">0</span>].indexOf(<span class="hljs-string">"--"</span>) !== <span class="hljs-number">0</span>) {
            $tw.boot.wikiPath = $tw.boot.argv[<span class="hljs-number">0</span>];
            $tw.boot.argv = $tw.boot.argv.slice(<span class="hljs-number">1</span>);
        } <span class="hljs-keyword">else</span> {
            $tw.boot.wikiPath = process.cwd();
        }
        <span class="hljs-comment">// Read package info</span>
        $tw.packageInfo = $tw.packageInfo || <span class="hljs-built_in">require</span>(<span class="hljs-string">"../package.json"</span>);
        <span class="hljs-comment">// Check node version number</span>
        <span class="hljs-keyword">if</span>(!$tw.utils.checkVersions(process.version.substr(<span class="hljs-number">1</span>),$tw.packageInfo.engines.node.substr(<span class="hljs-number">2</span>))) {
            $tw.utils.error(<span class="hljs-string">"TiddlyWiki5 requires node.js version "</span> + $tw.packageInfo.engines.node);
        }
    }
    <span class="hljs-comment">// Add file extension information</span>
    $tw.utils.registerFileType(<span class="hljs-string">"text/vnd.tiddlywiki"</span>,<span class="hljs-string">"utf8"</span>,<span class="hljs-string">".tid"</span>);
    $tw.utils.registerFileType(<span class="hljs-string">"application/x-tiddler"</span>,<span class="hljs-string">"utf8"</span>,<span class="hljs-string">".tid"</span>);
    $tw.utils.registerFileType(<span class="hljs-string">"application/x-tiddlers"</span>,<span class="hljs-string">"utf8"</span>,<span class="hljs-string">".multids"</span>);
    $tw.utils.registerFileType(<span class="hljs-string">"application/x-tiddler-html-div"</span>,<span class="hljs-string">"utf8"</span>,<span class="hljs-string">".tiddler"</span>);
    $tw.utils.registerFileType(<span class="hljs-string">"text/vnd.tiddlywiki2-recipe"</span>,<span class="hljs-string">"utf8"</span>,<span class="hljs-string">".recipe"</span>);
    $tw.utils.registerFileType(<span class="hljs-string">"text/plain"</span>,<span class="hljs-string">"utf8"</span>,<span class="hljs-string">".txt"</span>);
    $tw.utils.registerFileType(<span class="hljs-string">"text/css"</span>,<span class="hljs-string">"utf8"</span>,<span class="hljs-string">".css"</span>);
    $tw.utils.registerFileType(<span class="hljs-string">"text/html"</span>,<span class="hljs-string">"utf8"</span>,[<span class="hljs-string">".html"</span>,<span class="hljs-string">".htm"</span>]);
    $tw.utils.registerFileType(<span class="hljs-string">"application/hta"</span>,<span class="hljs-string">"utf16le"</span>,<span class="hljs-string">".hta"</span>,{<span class="hljs-attr">deserializerType</span>:<span class="hljs-string">"text/html"</span>});
    $tw.utils.registerFileType(<span class="hljs-string">"application/javascript"</span>,<span class="hljs-string">"utf8"</span>,<span class="hljs-string">".js"</span>);
    $tw.utils.registerFileType(<span class="hljs-string">"application/json"</span>,<span class="hljs-string">"utf8"</span>,<span class="hljs-string">".json"</span>);
    $tw.utils.registerFileType(<span class="hljs-string">"application/pdf"</span>,<span class="hljs-string">"base64"</span>,<span class="hljs-string">".pdf"</span>,{<span class="hljs-attr">flags</span>:[<span class="hljs-string">"image"</span>]});
    $tw.utils.registerFileType(<span class="hljs-string">"application/zip"</span>,<span class="hljs-string">"base64"</span>,<span class="hljs-string">".zip"</span>);
    $tw.utils.registerFileType(<span class="hljs-string">"application/x-zip-compressed"</span>,<span class="hljs-string">"base64"</span>,<span class="hljs-string">".zip"</span>);
    $tw.utils.registerFileType(<span class="hljs-string">"image/jpeg"</span>,<span class="hljs-string">"base64"</span>,[<span class="hljs-string">".jpg"</span>,<span class="hljs-string">".jpeg"</span>],{<span class="hljs-attr">flags</span>:[<span class="hljs-string">"image"</span>]});
    $tw.utils.registerFileType(<span class="hljs-string">"image/jpg"</span>,<span class="hljs-string">"base64"</span>,[<span class="hljs-string">".jpg"</span>,<span class="hljs-string">".jpeg"</span>],{<span class="hljs-attr">flags</span>:[<span class="hljs-string">"image"</span>]});
    $tw.utils.registerFileType(<span class="hljs-string">"image/png"</span>,<span class="hljs-string">"base64"</span>,<span class="hljs-string">".png"</span>,{<span class="hljs-attr">flags</span>:[<span class="hljs-string">"image"</span>]});
    $tw.utils.registerFileType(<span class="hljs-string">"image/gif"</span>,<span class="hljs-string">"base64"</span>,<span class="hljs-string">".gif"</span>,{<span class="hljs-attr">flags</span>:[<span class="hljs-string">"image"</span>]});
    $tw.utils.registerFileType(<span class="hljs-string">"image/webp"</span>,<span class="hljs-string">"base64"</span>,<span class="hljs-string">".webp"</span>,{<span class="hljs-attr">flags</span>:[<span class="hljs-string">"image"</span>]});
    $tw.utils.registerFileType(<span class="hljs-string">"image/heic"</span>,<span class="hljs-string">"base64"</span>,<span class="hljs-string">".heic"</span>,{<span class="hljs-attr">flags</span>:[<span class="hljs-string">"image"</span>]});
    $tw.utils.registerFileType(<span class="hljs-string">"image/heif"</span>,<span class="hljs-string">"base64"</span>,<span class="hljs-string">".heif"</span>,{<span class="hljs-attr">flags</span>:[<span class="hljs-string">"image"</span>]});
    $tw.utils.registerFileType(<span class="hljs-string">"image/svg+xml"</span>,<span class="hljs-string">"utf8"</span>,<span class="hljs-string">".svg"</span>,{<span class="hljs-attr">flags</span>:[<span class="hljs-string">"image"</span>]});
    $tw.utils.registerFileType(<span class="hljs-string">"image/vnd.microsoft.icon"</span>,<span class="hljs-string">"base64"</span>,<span class="hljs-string">".ico"</span>,{<span class="hljs-attr">flags</span>:[<span class="hljs-string">"image"</span>]});
    $tw.utils.registerFileType(<span class="hljs-string">"image/x-icon"</span>,<span class="hljs-string">"base64"</span>,<span class="hljs-string">".ico"</span>,{<span class="hljs-attr">flags</span>:[<span class="hljs-string">"image"</span>]});
    $tw.utils.registerFileType(<span class="hljs-string">"application/font-woff"</span>,<span class="hljs-string">"base64"</span>,<span class="hljs-string">".woff"</span>);
    $tw.utils.registerFileType(<span class="hljs-string">"application/x-font-ttf"</span>,<span class="hljs-string">"base64"</span>,<span class="hljs-string">".woff"</span>);
    $tw.utils.registerFileType(<span class="hljs-string">"application/font-woff2"</span>,<span class="hljs-string">"base64"</span>,<span class="hljs-string">".woff2"</span>);
    $tw.utils.registerFileType(<span class="hljs-string">"audio/ogg"</span>,<span class="hljs-string">"base64"</span>,<span class="hljs-string">".ogg"</span>);
    $tw.utils.registerFileType(<span class="hljs-string">"video/ogg"</span>,<span class="hljs-string">"base64"</span>,[<span class="hljs-string">".ogm"</span>,<span class="hljs-string">".ogv"</span>,<span class="hljs-string">".ogg"</span>]);
    $tw.utils.registerFileType(<span class="hljs-string">"video/webm"</span>,<span class="hljs-string">"base64"</span>,<span class="hljs-string">".webm"</span>);
    $tw.utils.registerFileType(<span class="hljs-string">"video/mp4"</span>,<span class="hljs-string">"base64"</span>,<span class="hljs-string">".mp4"</span>);
    $tw.utils.registerFileType(<span class="hljs-string">"audio/mp3"</span>,<span class="hljs-string">"base64"</span>,<span class="hljs-string">".mp3"</span>);
    $tw.utils.registerFileType(<span class="hljs-string">"audio/mp4"</span>,<span class="hljs-string">"base64"</span>,[<span class="hljs-string">".mp4"</span>,<span class="hljs-string">".m4a"</span>]);
    $tw.utils.registerFileType(<span class="hljs-string">"text/markdown"</span>,<span class="hljs-string">"utf8"</span>,[<span class="hljs-string">".md"</span>,<span class="hljs-string">".markdown"</span>],{<span class="hljs-attr">deserializerType</span>:<span class="hljs-string">"text/x-markdown"</span>});
    $tw.utils.registerFileType(<span class="hljs-string">"text/x-markdown"</span>,<span class="hljs-string">"utf8"</span>,[<span class="hljs-string">".md"</span>,<span class="hljs-string">".markdown"</span>]);
    $tw.utils.registerFileType(<span class="hljs-string">"application/enex+xml"</span>,<span class="hljs-string">"utf8"</span>,<span class="hljs-string">".enex"</span>);
    $tw.utils.registerFileType(<span class="hljs-string">"application/vnd.openxmlformats-officedocument.wordprocessingml.document"</span>,<span class="hljs-string">"base64"</span>,<span class="hljs-string">".docx"</span>);
    $tw.utils.registerFileType(<span class="hljs-string">"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"</span>,<span class="hljs-string">"base64"</span>,<span class="hljs-string">".xlsx"</span>);
    $tw.utils.registerFileType(<span class="hljs-string">"application/vnd.openxmlformats-officedocument.presentationml.presentation"</span>,<span class="hljs-string">"base64"</span>,<span class="hljs-string">".pptx"</span>);
    $tw.utils.registerFileType(<span class="hljs-string">"text/x-bibtex"</span>,<span class="hljs-string">"utf8"</span>,<span class="hljs-string">".bib"</span>,{<span class="hljs-attr">deserializerType</span>:<span class="hljs-string">"application/x-bibtex"</span>});
    $tw.utils.registerFileType(<span class="hljs-string">"application/x-bibtex"</span>,<span class="hljs-string">"utf8"</span>,<span class="hljs-string">".bib"</span>);
    $tw.utils.registerFileType(<span class="hljs-string">"application/epub+zip"</span>,<span class="hljs-string">"base64"</span>,<span class="hljs-string">".epub"</span>);
    $tw.utils.registerFileType(<span class="hljs-string">"application/octet-stream"</span>,<span class="hljs-string">"base64"</span>,<span class="hljs-string">".octet-stream"</span>);
    <span class="hljs-comment">// Create the wiki store for the app</span>
    $tw.wiki = <span class="hljs-keyword">new</span> $tw.Wiki();
    <span class="hljs-comment">// Install built in tiddler fields modules</span>
    $tw.Tiddler.fieldModules = $tw.modules.getModulesByTypeAsHashmap(<span class="hljs-string">"tiddlerfield"</span>);
    <span class="hljs-comment">// Install the tiddler deserializer modules</span>
    $tw.Wiki.tiddlerDeserializerModules = <span class="hljs-built_in">Object</span>.create(<span class="hljs-literal">null</span>);
    $tw.modules.applyMethods(<span class="hljs-string">"tiddlerdeserializer"</span>,$tw.Wiki.tiddlerDeserializerModules);
    <span class="hljs-comment">// Call unload handlers in the browser</span>
    <span class="hljs-keyword">if</span>($tw.browser) {
        <span class="hljs-built_in">window</span>.onbeforeunload = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">event</span>) </span>{
            event = event || {};
            <span class="hljs-keyword">var</span> result;
            $tw.utils.each($tw.unloadTasks,<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">task</span>) </span>{
                <span class="hljs-keyword">var</span> r = task(event);
                <span class="hljs-keyword">if</span>(r) {
                    result = r;
                }
            });
            <span class="hljs-keyword">return</span> result;
        }
    }
};
$tw.boot.loadStartup = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">options</span>)</span>{

    <span class="hljs-comment">// Load tiddlers</span>
    <span class="hljs-keyword">if</span>($tw.boot.tasks.readBrowserTiddlers) {
        $tw.loadTiddlersBrowser();
    } <span class="hljs-keyword">else</span> {
        $tw.loadTiddlersNode();
    }
    <span class="hljs-comment">// Load any preloaded tiddlers</span>
    <span class="hljs-keyword">if</span>($tw.preloadTiddlers) {
        $tw.wiki.addTiddlers($tw.preloadTiddlers);
    }
    <span class="hljs-comment">// Give hooks a chance to modify the store</span>
    $tw.hooks.invokeHook(<span class="hljs-string">"th-boot-tiddlers-loaded"</span>);
}
$tw.boot.execStartup = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">options</span>)</span>{
    <span class="hljs-comment">// Unpack plugin tiddlers</span>
    $tw.wiki.readPluginInfo();
    $tw.wiki.registerPluginTiddlers(<span class="hljs-string">"plugin"</span>,$tw.safeMode ? [<span class="hljs-string">"$:/core"</span>] : <span class="hljs-literal">undefined</span>);
    $tw.wiki.unpackPluginTiddlers();
    <span class="hljs-comment">// Process "safe mode"</span>
    <span class="hljs-keyword">if</span>($tw.safeMode) {
        $tw.wiki.processSafeMode();
    }
    <span class="hljs-comment">// Register typed modules from the tiddlers we've just loaded</span>
    $tw.wiki.defineTiddlerModules();
    <span class="hljs-comment">// And any modules within plugins</span>
    $tw.wiki.defineShadowModules();
    <span class="hljs-comment">// Make sure the crypto state tiddler is up to date</span>
    <span class="hljs-keyword">if</span>($tw.crypto) {
        $tw.crypto.updateCryptoStateTiddler();
    }
    <span class="hljs-comment">// Gather up any startup modules</span>
    $tw.boot.remainingStartupModules = []; <span class="hljs-comment">// Array of startup modules</span>
    $tw.modules.forEachModuleOfType(<span class="hljs-string">"startup"</span>,<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">title,module</span>) </span>{
        <span class="hljs-keyword">if</span>(<span class="hljs-built_in">module</span>.startup) {
            $tw.boot.remainingStartupModules.push(<span class="hljs-built_in">module</span>);
        }
    });
    <span class="hljs-comment">// Keep track of the startup tasks that have been executed</span>
    $tw.boot.executedStartupModules = <span class="hljs-built_in">Object</span>.create(<span class="hljs-literal">null</span>);
    $tw.boot.disabledStartupModules = $tw.boot.disabledStartupModules || [];
    <span class="hljs-comment">// Repeatedly execute the next eligible task</span>
    $tw.boot.executeNextStartupTask(options.callback);
}
<span class="hljs-comment">/*
Startup TiddlyWiki
*/</span>
$tw.boot.startup = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">options</span>) </span>{
    options = options || {};
    <span class="hljs-comment">// Get the URL hash and check for safe mode</span>
    $tw.boot.initStartup(options);
    $tw.boot.loadStartup(options);
    $tw.boot.execStartup(options);
};

<span class="hljs-comment">/*
Add another unload task
*/</span>
$tw.addUnloadTask = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">task</span>) </span>{
    <span class="hljs-keyword">if</span>($tw.unloadTasks.indexOf(task) === <span class="hljs-number">-1</span>) {
        $tw.unloadTasks.push(task);
    }
}

<span class="hljs-comment">/*
Execute the remaining eligible startup tasks
*/</span>
$tw.boot.executeNextStartupTask = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">callback</span>) </span>{
    <span class="hljs-comment">// Find the next eligible task</span>
    <span class="hljs-keyword">var</span> taskIndex = <span class="hljs-number">0</span>, task,
        asyncTaskCallback = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            <span class="hljs-keyword">if</span>(task.name) {
                $tw.boot.executedStartupModules[task.name] = <span class="hljs-literal">true</span>;
            }
            <span class="hljs-keyword">return</span> $tw.boot.executeNextStartupTask(callback);
        };
    <span class="hljs-keyword">while</span>(taskIndex &lt; $tw.boot.remainingStartupModules.length) {
        task = $tw.boot.remainingStartupModules[taskIndex];
        <span class="hljs-keyword">if</span>($tw.boot.isStartupTaskEligible(task)) {
            <span class="hljs-comment">// Remove this task from the list</span>
            $tw.boot.remainingStartupModules.splice(taskIndex,<span class="hljs-number">1</span>);
            <span class="hljs-comment">// Assemble log message</span>
            <span class="hljs-keyword">var</span> s = [<span class="hljs-string">"Startup task:"</span>,task.name];
            <span class="hljs-keyword">if</span>(task.platforms) {
                s.push(<span class="hljs-string">"platforms:"</span>,task.platforms.join(<span class="hljs-string">","</span>));
            }
            <span class="hljs-keyword">if</span>(task.after) {
                s.push(<span class="hljs-string">"after:"</span>,task.after.join(<span class="hljs-string">","</span>));
            }
            <span class="hljs-keyword">if</span>(task.before) {
                s.push(<span class="hljs-string">"before:"</span>,task.before.join(<span class="hljs-string">","</span>));
            }
            $tw.boot.log(s.join(<span class="hljs-string">" "</span>));
            <span class="hljs-comment">// Execute task</span>
            <span class="hljs-keyword">if</span>(!$tw.utils.hop(task,<span class="hljs-string">"synchronous"</span>) || task.synchronous) {
                task.startup();
                <span class="hljs-keyword">if</span>(task.name) {
                    $tw.boot.executedStartupModules[task.name] = <span class="hljs-literal">true</span>;
                }
                <span class="hljs-keyword">return</span> $tw.boot.executeNextStartupTask(callback);
            } <span class="hljs-keyword">else</span> {
                task.startup(asyncTaskCallback);
                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
            }
        }
        taskIndex++;
    }
    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">typeof</span> callback === <span class="hljs-string">'function'</span>) {
        callback();
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
};

<span class="hljs-comment">/*
Returns true if we are running on one of the platforms specified in taskModule's
`platforms` array; or if `platforms` property is not defined.
*/</span>
$tw.boot.doesTaskMatchPlatform = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">taskModule</span>) </span>{
    <span class="hljs-keyword">var</span> platforms = taskModule.platforms;
    <span class="hljs-keyword">if</span>(platforms) {
        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> t=<span class="hljs-number">0</span>; t&lt;platforms.length; t++) {
            <span class="hljs-keyword">switch</span> (platforms[t]) {
                <span class="hljs-keyword">case</span> <span class="hljs-string">"browser"</span>:
                    <span class="hljs-keyword">if</span> ($tw.browser) {
                        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
                    }
                    <span class="hljs-keyword">break</span>;
                <span class="hljs-keyword">case</span> <span class="hljs-string">"node"</span>:
                    <span class="hljs-keyword">if</span> ($tw.node) {
                        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
                    }
                    <span class="hljs-keyword">break</span>;
                <span class="hljs-keyword">default</span>:
                    $tw.utils.error(<span class="hljs-string">"Module "</span> + taskModule.name + <span class="hljs-string">": '"</span> + platforms[t] + <span class="hljs-string">"' in export.platforms invalid"</span>);
            }
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
};

$tw.boot.isStartupTaskEligible = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">taskModule</span>) </span>{
    <span class="hljs-keyword">var</span> t;
    <span class="hljs-comment">// Check that the platform is correct</span>
    <span class="hljs-keyword">if</span>(!$tw.boot.doesTaskMatchPlatform(taskModule)) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
    <span class="hljs-keyword">var</span> name = taskModule.name,
        remaining = $tw.boot.remainingStartupModules;
    <span class="hljs-keyword">if</span>(name) {
        <span class="hljs-comment">// Fail if this module is disabled</span>
        <span class="hljs-keyword">if</span>($tw.boot.disabledStartupModules.indexOf(name) !== <span class="hljs-number">-1</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
        <span class="hljs-comment">// Check that no other outstanding tasks must be executed before this one</span>
        <span class="hljs-keyword">for</span>(t=<span class="hljs-number">0</span>; t&lt;remaining.length; t++) {
            <span class="hljs-keyword">var</span> task = remaining[t];
            <span class="hljs-keyword">if</span>(task.before &amp;&amp; task.before.indexOf(name) !== <span class="hljs-number">-1</span>) {
                <span class="hljs-keyword">if</span>($tw.boot.doesTaskMatchPlatform(task) || (task.name &amp;&amp; $tw.boot.disabledStartupModules.indexOf(name) !== <span class="hljs-number">-1</span>)) {
                    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
                }
            }
        }
    }
    <span class="hljs-comment">// Check that all of the tasks that we must be performed after has been done</span>
    <span class="hljs-keyword">var</span> after = taskModule.after;
    <span class="hljs-keyword">if</span>(after) {
        <span class="hljs-keyword">for</span>(t=<span class="hljs-number">0</span>; t&lt;after.length; t++) {
            <span class="hljs-keyword">if</span>(!$tw.boot.executedStartupModules[after[t]]) {
                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
            }
        }
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
};

<span class="hljs-comment">/*
Global Hooks mechanism which allows plugins to modify default functionality
*/</span>
$tw.hooks = $tw.hooks || { <span class="hljs-attr">names</span>: {}};

<span class="hljs-comment">/*
Add hooks to the  hashmap
*/</span>
$tw.hooks.addHook = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">hookName,definition</span>) </span>{
    <span class="hljs-keyword">if</span>($tw.utils.hop($tw.hooks.names,hookName)) {
        $tw.hooks.names[hookName].push(definition);
    }
    <span class="hljs-keyword">else</span> {
        $tw.hooks.names[hookName] = [definition];
    }
};

<span class="hljs-comment">/*
Invoke the hook by key
*/</span>
$tw.hooks.invokeHook = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">hookName <span class="hljs-regexp">/*, value,... */</span></span>) </span>{
    <span class="hljs-keyword">var</span> args = <span class="hljs-built_in">Array</span>.prototype.slice.call(<span class="hljs-built_in">arguments</span>,<span class="hljs-number">1</span>);
    <span class="hljs-keyword">if</span>($tw.utils.hop($tw.hooks.names,hookName)) {
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; $tw.hooks.names[hookName].length; i++) {
            args[<span class="hljs-number">0</span>] = $tw.hooks.names[hookName][i].apply(<span class="hljs-literal">null</span>,args);
        }
    }
    <span class="hljs-keyword">return</span> args[<span class="hljs-number">0</span>];
};

<span class="hljs-comment">/////////////////////////// Main boot function to decrypt tiddlers and then startup</span>

$tw.boot.boot = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">callback</span>) </span>{
    <span class="hljs-comment">// Initialise crypto object</span>
    $tw.crypto = <span class="hljs-keyword">new</span> $tw.utils.Crypto();
    <span class="hljs-comment">// Initialise password prompter</span>
    <span class="hljs-keyword">if</span>($tw.browser &amp;&amp; !$tw.node) {
        $tw.passwordPrompt = <span class="hljs-keyword">new</span> $tw.utils.PasswordPrompt();
    }
    <span class="hljs-comment">// Preload any encrypted tiddlers</span>
    $tw.boot.decryptEncryptedTiddlers(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-comment">// Startup</span>
        $tw.boot.startup({<span class="hljs-attr">callback</span>: callback});
    });
};

<span class="hljs-comment">/////////////////////////// Autoboot in the browser</span>

<span class="hljs-keyword">if</span>($tw.browser &amp;&amp; !$tw.boot.suppressBoot) {
    $tw.boot.boot();
}

<span class="hljs-keyword">return</span> $tw;

});

<span class="hljs-keyword">if</span>(<span class="hljs-keyword">typeof</span>(exports) !== <span class="hljs-string">"undefined"</span>) {
    exports.TiddlyWiki = _boot;
} <span class="hljs-keyword">else</span> {
    _boot(<span class="hljs-built_in">window</span>.$tw);
}
</code></pre></div>

<div class="tc-tiddler-plugin-info tc-reveal"><p>
</p></div><br>

<hr>

<p>未链接子条目：</p><p><ul class="">无</ul></p>

父条目：

<ul class="">无</ul><p>因为本博客暂不支持评论功能，想要留言还请移步<a class="tc-tiddlylink-external" href="https://www.cnblogs.com/frank3215/p/comments.html" rel="noopener noreferrer" target="_blank">我的博客园</a>。也可以通过<a class="tc-tiddlylink-external" href="mailto:frank3215@163.com" rel="noopener noreferrer" target="_blank">我的邮箱</a><code>frank3215@163.com</code>或<a class="tc-tiddlylink-external" href="https://www.luogu.com.cn/user/73915" rel="noopener noreferrer" target="_blank">我的洛谷帐号</a><code>frank3215</code>私信联系我。</p></div></p>
</section>
</body>
</html>

